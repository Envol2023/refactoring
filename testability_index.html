<!DOCTYPE html><html lang="fr"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, minimal-ui"><title>Testabilit√©</title><meta name="author" content="slide"><link rel="stylesheet" href="reveal.js/dist/reset.css"><link rel="stylesheet" href="reveal.js/dist/reveal.css"><link rel="stylesheet" href="custom/cours.css" id="theme"><!--This CSS is generated by the Asciidoctor reveal.js converter to further integrate AsciiDoc's existing semantic with reveal.js--><style type="text/css">.reveal div.right {
  float: right
}

/* source blocks */
.reveal .listingblock.stretch > .content {
  height: 100%
}

.reveal .listingblock.stretch > .content > pre {
  height: 100%
}

.reveal .listingblock.stretch > .content > pre > code {
  height: 100%;
  max-height: 100%
}

/* auto-animate feature */
/* hide the scrollbar when auto-animating source blocks */
.reveal pre[data-auto-animate-target] {
  overflow: hidden;
}

.reveal pre[data-auto-animate-target] code {
  overflow: hidden;
}

/* add a min width to avoid horizontal shift on line numbers */
code.hljs .hljs-ln-line.hljs-ln-n {
  min-width: 1.25em;
}

/* tables */
table {
  border-collapse: collapse;
  border-spacing: 0
}

table {
  margin-bottom: 1.25em;
  border: solid 1px #dedede
}

table thead tr th, table thead tr td, table tfoot tr th, table tfoot tr td {
  padding: .5em .625em .625em;
  font-size: inherit;
  text-align: left
}

table tr th, table tr td {
  padding: .5625em .625em;
  font-size: inherit
}

table thead tr th, table tfoot tr th, table tbody tr td, table tr td, table tfoot tr td {
  display: table-cell;
  line-height: 1.6
}

td.tableblock > .content {
  margin-bottom: 1.25em
}

td.tableblock > .content > :last-child {
  margin-bottom: -1.25em
}

table.tableblock, th.tableblock, td.tableblock {
  border: 0 solid #dedede
}

table.grid-all > thead > tr > .tableblock, table.grid-all > tbody > tr > .tableblock {
  border-width: 0 1px 1px 0
}

table.grid-all > tfoot > tr > .tableblock {
  border-width: 1px 1px 0 0
}

table.grid-cols > * > tr > .tableblock {
  border-width: 0 1px 0 0
}

table.grid-rows > thead > tr > .tableblock, table.grid-rows > tbody > tr > .tableblock {
  border-width: 0 0 1px
}

table.grid-rows > tfoot > tr > .tableblock {
  border-width: 1px 0 0
}

table.grid-all > * > tr > .tableblock:last-child, table.grid-cols > * > tr > .tableblock:last-child {
  border-right-width: 0
}

table.grid-all > tbody > tr:last-child > .tableblock, table.grid-all > thead:last-child > tr > .tableblock, table.grid-rows > tbody > tr:last-child > .tableblock, table.grid-rows > thead:last-child > tr > .tableblock {
  border-bottom-width: 0
}

table.frame-all {
  border-width: 1px
}

table.frame-sides {
  border-width: 0 1px
}

table.frame-topbot, table.frame-ends {
  border-width: 1px 0
}

.reveal table th.halign-left, .reveal table td.halign-left {
  text-align: left
}

.reveal table th.halign-right, .reveal table td.halign-right {
  text-align: right
}

.reveal table th.halign-center, .reveal table td.halign-center {
  text-align: center
}

.reveal table th.valign-top, .reveal table td.valign-top {
  vertical-align: top
}

.reveal table th.valign-bottom, .reveal table td.valign-bottom {
  vertical-align: bottom
}

.reveal table th.valign-middle, .reveal table td.valign-middle {
  vertical-align: middle
}

table thead th, table tfoot th {
  font-weight: bold
}

tbody tr th {
  display: table-cell;
  line-height: 1.6
}

tbody tr th, tbody tr th p, tfoot tr th, tfoot tr th p {
  font-weight: bold
}

thead {
  display: table-header-group
}

.reveal table.grid-none th, .reveal table.grid-none td {
  border-bottom: 0 !important
}

/* kbd macro */
kbd {
  font-family: "Droid Sans Mono", "DejaVu Sans Mono", monospace;
  display: inline-block;
  color: rgba(0, 0, 0, .8);
  font-size: .65em;
  line-height: 1.45;
  background: #f7f7f7;
  border: 1px solid #ccc;
  -webkit-border-radius: 3px;
  border-radius: 3px;
  -webkit-box-shadow: 0 1px 0 rgba(0, 0, 0, .2), 0 0 0 .1em white inset;
  box-shadow: 0 1px 0 rgba(0, 0, 0, .2), 0 0 0 .1em #fff inset;
  margin: 0 .15em;
  padding: .2em .5em;
  vertical-align: middle;
  position: relative;
  top: -.1em;
  white-space: nowrap
}

.keyseq kbd:first-child {
  margin-left: 0
}

.keyseq kbd:last-child {
  margin-right: 0
}

/* callouts */
.conum[data-value] {
  display: inline-block;
  color: #fff !important;
  background: rgba(0, 0, 0, .8);
  -webkit-border-radius: 50%;
  border-radius: 50%;
  text-align: center;
  font-size: .75em;
  width: 1.67em;
  height: 1.67em;
  line-height: 1.67em;
  font-family: "Open Sans", "DejaVu Sans", sans-serif;
  font-style: normal;
  font-weight: bold
}

.conum[data-value] * {
  color: #fff !important
}

.conum[data-value] + b {
  display: none
}

.conum[data-value]:after {
  content: attr(data-value)
}

pre .conum[data-value] {
  position: relative;
  top: -.125em
}

b.conum * {
  color: inherit !important
}

.conum:not([data-value]):empty {
  display: none
}

/* Callout list */
.hdlist > table, .colist > table {
  border: 0;
  background: none
}

.hdlist > table > tbody > tr, .colist > table > tbody > tr {
  background: none
}

td.hdlist1, td.hdlist2 {
  vertical-align: top;
  padding: 0 .625em
}

td.hdlist1 {
  font-weight: bold;
  padding-bottom: 1.25em
}

/* Disabled from Asciidoctor CSS because it caused callout list to go under the
 * source listing when .stretch is applied (see #335)
 * .literalblock+.colist,.listingblock+.colist{margin-top:-.5em} */
.colist td:not([class]):first-child {
  padding: .4em .75em 0;
  line-height: 1;
  vertical-align: top
}

.colist td:not([class]):first-child img {
  max-width: none
}

.colist td:not([class]):last-child {
  padding: .25em 0
}

/* Override Asciidoctor CSS that causes issues with reveal.js features */
.reveal .hljs table {
  border: 0
}

/* Callout list rows would have a bottom border with some reveal.js themes (see #335) */
.reveal .colist > table th, .reveal .colist > table td {
  border-bottom: 0
}

/* Fixes line height with Highlight.js source listing when linenums enabled (see #331) */
.reveal .hljs table thead tr th, .reveal .hljs table tfoot tr th, .reveal .hljs table tbody tr td, .reveal .hljs table tr td, .reveal .hljs table tfoot tr td {
  line-height: inherit
}

/* Columns layout */
.columns .slide-content {
  display: flex;
}

.columns.wrap .slide-content {
  flex-wrap: wrap;
}

.columns.is-vcentered .slide-content {
  align-items: center;
}

.columns .slide-content > .column {
  display: block;
  flex-basis: 0;
  flex-grow: 1;
  flex-shrink: 1;
}

.columns .slide-content > .column > * {
  padding: .75rem;
}

/* See #353 */
.columns.wrap .slide-content > .column {
  flex-basis: auto;
}

.columns .slide-content > .column.is-full {
  flex: none;
  width: 100%;
}

.columns .slide-content > .column.is-four-fifths {
  flex: none;
  width: 80%;
}

.columns .slide-content > .column.is-three-quarters {
  flex: none;
  width: 75%;
}

.columns .slide-content > .column.is-two-thirds {
  flex: none;
  width: 66.6666%;
}

.columns .slide-content > .column.is-three-fifths {
  flex: none;
  width: 60%;
}

.columns .slide-content > .column.is-half {
  flex: none;
  width: 50%;
}

.columns .slide-content > .column.is-two-fifths {
  flex: none;
  width: 40%;
}

.columns .slide-content > .column.is-one-third {
  flex: none;
  width: 33.3333%;
}

.columns .slide-content > .column.is-one-quarter {
  flex: none;
  width: 25%;
}

.columns .slide-content > .column.is-one-fifth {
  flex: none;
  width: 20%;
}

.columns .slide-content > .column.has-text-left {
  text-align: left;
}

.columns .slide-content > .column.has-text-justified {
  text-align: justify;
}

.columns .slide-content > .column.has-text-right {
  text-align: right;
}

.columns .slide-content > .column.has-text-left {
  text-align: left;
}

.columns .slide-content > .column.has-text-justified {
  text-align: justify;
}

.columns .slide-content > .column.has-text-right {
  text-align: right;
}

.text-left {
  text-align: left !important
}

.text-right {
  text-align: right !important
}

.text-center {
  text-align: center !important
}

.text-justify {
  text-align: justify !important
}

.footnotes {
  border-top: 1px solid rgba(0, 0, 0, 0.2);
  padding: 0.5em 0 0 0;
  font-size: 0.65em;
  margin-top: 4em;
}

.byline {
  font-size:.8em
}
ul.byline {
  list-style-type: none;
}
ul.byline li + li {
  margin-top: 0.25em;
}
</style><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.1/css/all.min.css"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.1/css/v4-shims.min.css"><style>
/*! Stylesheet for CodeRay to loosely match GitHub themes | MIT License */
pre.CodeRay{background:#f7f7f8}
.CodeRay .line-numbers{border-right:1px solid;opacity:.35;padding:0 .5em 0 0;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}
.CodeRay span.line-numbers{display:inline-block;margin-right:.75em}
.CodeRay .line-numbers strong{color:#000}
table.CodeRay{border-collapse:separate;border:0;margin-bottom:0;background:none}
table.CodeRay td{vertical-align:top;line-height:inherit}
table.CodeRay td.line-numbers{text-align:right}
table.CodeRay td.code{padding:0 0 0 .75em}
.CodeRay .debug{color:#fff!important;background:navy!important}
.CodeRay .annotation{color:#007}
.CodeRay .attribute-name{color:navy}
.CodeRay .attribute-value{color:#700}
.CodeRay .binary{color:#509}
.CodeRay .comment{color:#998;font-style:italic}
.CodeRay .char{color:#04d}
.CodeRay .char .content{color:#04d}
.CodeRay .char .delimiter{color:#039}
.CodeRay .class{color:#458;font-weight:bold}
.CodeRay .complex{color:#a08}
.CodeRay .constant,.CodeRay .predefined-constant{color:teal}
.CodeRay .color{color:#099}
.CodeRay .class-variable{color:#369}
.CodeRay .decorator{color:#b0b}
.CodeRay .definition{color:#099}
.CodeRay .delimiter{color:#000}
.CodeRay .doc{color:#970}
.CodeRay .doctype{color:#34b}
.CodeRay .doc-string{color:#d42}
.CodeRay .escape{color:#666}
.CodeRay .entity{color:#800}
.CodeRay .error{color:#808}
.CodeRay .exception{color:inherit}
.CodeRay .filename{color:#099}
.CodeRay .function{color:#900;font-weight:bold}
.CodeRay .global-variable{color:teal}
.CodeRay .hex{color:#058}
.CodeRay .integer,.CodeRay .float{color:#099}
.CodeRay .include{color:#555}
.CodeRay .inline{color:#000}
.CodeRay .inline .inline{background:#ccc}
.CodeRay .inline .inline .inline{background:#bbb}
.CodeRay .inline .inline-delimiter{color:#d14}
.CodeRay .inline-delimiter{color:#d14}
.CodeRay .important{color:#555;font-weight:bold}
.CodeRay .interpreted{color:#b2b}
.CodeRay .instance-variable{color:teal}
.CodeRay .label{color:#970}
.CodeRay .local-variable{color:#963}
.CodeRay .octal{color:#40e}
.CodeRay .predefined{color:#369}
.CodeRay .preprocessor{color:#579}
.CodeRay .pseudo-class{color:#555}
.CodeRay .directive{font-weight:bold}
.CodeRay .type{font-weight:bold}
.CodeRay .predefined-type{color:inherit}
.CodeRay .reserved,.CodeRay .keyword{color:#000;font-weight:bold}
.CodeRay .key{color:#808}
.CodeRay .key .delimiter{color:#606}
.CodeRay .key .char{color:#80f}
.CodeRay .value{color:#088}
.CodeRay .regexp .delimiter{color:#808}
.CodeRay .regexp .content{color:#808}
.CodeRay .regexp .modifier{color:#808}
.CodeRay .regexp .char{color:#d14}
.CodeRay .regexp .function{color:#404;font-weight:bold}
.CodeRay .string{color:#d20}
.CodeRay .string .string .string{background:#ffd0d0}
.CodeRay .string .content{color:#d14}
.CodeRay .string .char{color:#d14}
.CodeRay .string .delimiter{color:#d14}
.CodeRay .shell{color:#d14}
.CodeRay .shell .delimiter{color:#d14}
.CodeRay .symbol{color:#990073}
.CodeRay .symbol .content{color:#a60}
.CodeRay .symbol .delimiter{color:#630}
.CodeRay .tag{color:teal}
.CodeRay .tag-special{color:#d70}
.CodeRay .variable{color:#036}
.CodeRay .insert{background:#afa}
.CodeRay .delete{background:#faa}
.CodeRay .change{color:#aaf;background:#007}
.CodeRay .head{color:#f8f;background:#505}
.CodeRay .insert .insert{color:#080}
.CodeRay .delete .delete{color:#800}
.CodeRay .change .change{color:#66f}
.CodeRay .head .head{color:#f4f}
</style><link rel="stylesheet" href="custom/customcss.css"></head><body><div class="reveal"><div class="slides"><section class="title" data-state="title"><h1>Testabilit√©</h1><p class="byline">
  <span class="author">slide</span>
  </p></section><section id="_todo"><h2>TODO</h2><div class="slide-content"><div class="ulist"><ul><li><p>testability and responsibility</p></li><li><p>testability and abstraction</p></li></ul></div></div></section>
<section><section id="_am√©liorer_la_testabilit√©" class="start background center"><h2>Am√©liorer la testabilit√©</h2></section><section id="_limmobilisation_par_la_peur"><h2>L&#8217;immobilisation par la peur</h2><div class="slide-content"><div class="ulist"><ul><li><p>La peur de tout casser.</p><div class="ulist"><ul><li><p>&#8658; Premier frein au changement</p></li></ul></div></li></ul></div>
<div class="imageblock"><img src="../images/break_everything.gif" alt="break everything"></div>
<div class="paragraph"><p>Aucune √©volution n&#8217;est possible, √† un rythme <em>soutenable</em> sans confiance.</p></div></div></section></section>
<section><section id="_la_pierre_philosophale"><h2>La pierre philosophale</h2><div class="slide-content"><div class="quoteblock"><blockquote><div class="paragraph"><p>Tests are the Programmer&#8217;s stone, transmuting fear into boredom.</p></div></blockquote><div class="attribution">&#8212; Kent Beck</div></div></div></section><section id="_definition_de_la_testabilit√©"><h2>Definition de la Testabilit√©</h2><div class="slide-content"><div class="quoteblock"><blockquote><div class="paragraph"><p>La testabilit√© d&#8217;un module est la facilit√© √† cr√©er une s√©rie de tests automatis√©s.</p></div></blockquote></div>
<div class="ulist"><ul><li><p>Qualit√© Logicielle</p><div class="ulist"><ul><li><p>Une des caract√©ristiques de la <em>Maintenabilit√©</em></p></li></ul></div></li></ul></div></div></section></section>
<section><section id="_l√©chec_comme_premier_pas"><h2>L&#8217;√©chec comme premier pas.</h2><div class="slide-content"><div class="paragraph"><p>Dans la philosophe des tests, l&#8217;√©chec n&#8217;est pas n√©gatif, c&#8217;est sa persistence qu&#8217;il l&#8217;est √©ventuellement.</p></div><div class="paragraph"><p>L&#8217;√©chec indique qu&#8217;un √©tat souhait√© n&#8217;est pas atteint. L&#8217;objectif est de l&#8217;atteindre</p></div></div></section><section id="_cycle_de_vie_d√©veloppement_normal"><h2>Cycle de vie &gt; D√©veloppement Normal</h2><div class="slide-content"><div class="imageblock center"><img src="../images/pytest-lifecycle.png" alt="pytest lifecycle"></div></div></section><section id="_cycle_de_vie_bug_fix"><h2>Cycle de vie &gt; Bug fix</h2><div class="slide-content"><div class="imageblock center"><img src="../images/pytest-bugfix-lifecycle.png" alt="pytest bugfix lifecycle"></div></div></section><section id="_le_tdd_et_refactoring"><h2>Le TDD et refactoring</h2><div class="slide-content"><div class="ulist"><ul><li><p><em>Test Driven Development</em></p><div class="ulist"><ul><li><p>Approche √©rig√©e en philosophie</p></li></ul></div></li></ul></div>
<div class="quoteblock"><blockquote><div class="paragraph"><p>"Code that isn&#8217;t tested doesn&#8217;t work - this seems to be the safe assumption."</p></div></blockquote><div class="attribution">&#8212; Kent Beck</div></div></div></section><section id="_le_tdd_et_refactoring_2"><h2>Le TDD et refactoring</h2><div class="slide-content"><div class="imageblock center"><img src="../images/pytest-tdd-lifecycle.png" alt="pytest tdd lifecycle"></div></div></section><section id="_testabilit√©_conception_et_confiance"><h2>Testabilit√©, conception et confiance</h2><div class="slide-content"><div class="openblock left-column center"><div class="content"><div class="paragraph"><p>Cercle vertueux</p></div>
<div class="imageblock"><img src="../images/testability-cercle-vertueux.svg" alt="testability cercle vertueux"></div></div></div>
<div class="openblock right-column center fragment"><div class="content"><div class="paragraph"><p>Cercle vicieux</p></div>
<div class="imageblock"><img src="../images/testability-cercle-vicieux.svg" alt="testability cercle vicieux"></div></div></div>
<div class="openblock reset-column center fragment"><div class="content"><div class="quoteblock"><blockquote><div class="paragraph"><p>"R√©alisez les projets avec des personnes motiv√©es. Fournissez-leur l&#8217;environnement et le soutien dont elles ont besoin et <em>faites-leur confiance</em> pour atteindre les objectifs fix√©s."</p></div></blockquote></div></div></div>
<aside class="notes"><div class="paragraph"><p>Il y a une relation tr√®s claire entre la conception, la testabilit√© et la confiance que nous pla√ßons dans le code.
Cette confiance agit directement sur notre motivation, notre engagement sur le projet lui-m√™me.</p></div>
<div class="paragraph"><p>La motivation est un principe tr√®s fort dans l&#8217;agilit√©. L&#8217;un de ces principes n&#8217;est-il pas ?</p></div>
<div class="quoteblock"><blockquote><div class="paragraph"><p>R√©alisez les projets avec des personnes motiv√©es. Fournissez-leur l&#8217;environnement et le soutien dont elles ont besoin et <em>faites-leur confiance</em> pour atteindre les objectifs fix√©s.</p></div></blockquote></div></aside></div></section><section id="_les_tests_comme_bac_√†_sable"><h2>Les tests comme bac √† sable</h2><div class="slide-content"><div class="ulist"><ul><li><p>Tester pour mieux cerner</p><div class="ulist"><ul><li><p>Contexte fonctionnel pour prototyper</p></li><li><p>Jouer avec un algorithme sans lancer la grosse machinerie</p></li></ul></div></li><li><p>D√©marche</p><div class="ulist"><ul><li><p>(1) Cr√©er un test unitaire</p></li><li><p>(2) T√¢tonner avec un algorithme</p></li><li><p>(3) R√©ussir √† passer le test</p></li><li><p>(4) &#8658; Refactoriser l&#8217;algorithme en <em>beau</em> code bien <em>clean</em></p></li></ul></div></li><li><p>TDD √† la petite semaine</p><div class="ulist"><ul><li><p>Pythoneux: alternative au notebook <em>pour voir</em></p></li></ul></div></li></ul></div>
<aside class="notes"><div class="paragraph"><p>Les test sont un merveilleux moyen d&#8217;exp√©rimenter des algorithmes sans avoir √† lancer des processus ou des traitements tr√®s lourds.
Il arrive, quand on d√©veloppe des pipelines de traitements de donn√©e, d&#8217;avoir √† relancer de lourds traitement pour tester des algorithmes.
Le fait de mettre en place des tests, m√™me grossi√®rement, oblige √† penser plus petit, plus r√©duit, plus concentr√©.
Une fois le cadre en place, il devient plaisant, dans un cadre simple, r√©p√©titif, sans risque de bidouiller un peu pour voir comment prendre un probl√®me en main.</p></div></aside>
<div class="openblock at-top-right"><div class="content"><div class="imageblock right"><img src="../images/stitch.gif" alt="stitch"></div></div></div></div></section><section id="_la_testabilit√©_et_qualit√©_de_conception"><h2>La testabilit√© et qualit√© de conception</h2><div class="slide-content"><div class="quoteblock"><blockquote><div class="paragraph"><p>"if an airplane looks good, it will fly good."</p></div></blockquote></div>
<div class="imageblock center"><img src="../images/15_Supermarine_Spitfire_R6923,_QJ-S_(15836050395).jpg" alt="15 Supermarine Spitfire R6923, QJ S (15836050395)"></div>
<div class="quoteblock"><blockquote><div class="paragraph"><p>Si un code se teste facilement, il ne peut pas √™tre enti√®rement mauvais&#8230;&#8203;</p></div></blockquote></div>
<aside class="notes"><div class="paragraph"><p>Ce n&#8217;est pas une r√©alit√© statistique, mais c&#8217;est motivant.</p></div></aside></div></section><section id="_la_testabilit√©_et_qualit√©_de_conception_2"><h2>La testabilit√© et qualit√© de conception</h2><div class="slide-content"><div class="ulist"><ul><li><p>Testabilit√© = indicateur de qualit√© de conception</p><div class="ulist"><ul><li><p>Un code difficile √† tester &#8594; Faiblesses de conception</p></li><li><p>&#8658; Revoir la conception</p></li></ul></div></li><li><p>La r√©ciproque est-elle vraie ?</p><div class="ulist"><ul><li><p>D√©bat&#8230;&#8203;</p></li></ul></div></li></ul></div></div></section></section>
<section><section id="_test_facile"><h2>Test facile</h2><div class="slide-content"><div class="paragraph"><p>Une simple fonction √† tester</p></div><div class="listingblock big"><div class="content"><pre class="CodeRay highlight"><code data-lang="python"><span class="keyword">def</span> <span class="function">filter_info_log</span>(logs: List[Log]) -&gt; List[Log]:
    <span class="keyword">return</span> [log <span class="keyword">for</span> log <span class="keyword">in</span> logs <span class="keyword">if</span> log.level == <span class="string"><span class="delimiter">&quot;</span><span class="content">INFO</span><span class="delimiter">&quot;</span></span>]</code></pre></div></div><div class="openblock left-column"><div class="content"><div class="listingblock big"><div class="content"><pre class="CodeRay highlight"><code data-lang="python"><span class="keyword">def</span> <span class="function">test_filter_info_log_empty</span>():
    <span class="comment"># Given</span>
    logs = []

    <span class="comment"># When</span>
    result = filter_info_log(logs)

    <span class="comment"># Then</span>
    <span class="keyword">assert</span> result == []</code></pre></div></div></div></div><div class="openblock right-column"><div class="content"><div class="listingblock big"><div class="content"><pre class="CodeRay highlight"><code data-lang="python"><span class="keyword">def</span> <span class="function">test_filter_info_log_no_info_logs</span>():
    <span class="comment"># Given</span>
    logs = [Log(level=<span class="string"><span class="delimiter">&quot;</span><span class="content">ERROR</span><span class="delimiter">&quot;</span></span>)]

    <span class="comment"># When</span>
    result = filter_info_log(logs)

    <span class="comment"># Then</span>
    <span class="keyword">assert</span> result == []</code></pre></div></div></div></div></div></section><section id="_test_moins_facile"><h2>Test moins facile</h2><div class="slide-content"><div class="paragraph"><p>Un filtre plus √©labor√© avec des r√®gles</p></div>
<div class="listingblock big"><div class="content"><pre class="CodeRay highlight"><code data-lang="python"><span class="keyword">class</span> <span class="class">LogFilter</span>:
    <span class="keyword">def</span> <span class="function">__init__</span>(<span class="predefined-constant">self</span>, rules: Rules):
        <span class="predefined-constant">self</span>.rules = rules

    <span class="keyword">def</span> <span class="function">filter_info_log</span>(<span class="predefined-constant">self</span>, logs: List[Log]) -&gt; List[Log]:
        <span class="keyword">return</span> [log <span class="keyword">for</span> log <span class="keyword">in</span> logs <span class="keyword">if</span> <span class="predefined-constant">self</span>.rules.validate(log, <span class="string"><span class="delimiter">&quot;</span><span class="content">INFOS</span><span class="delimiter">&quot;</span></span>)]</code></pre></div></div>
<div class="openblock left-column"><div class="content"><div class="listingblock big"><div class="content"><pre class="CodeRay highlight"><code data-lang="python"><span class="keyword">def</span> <span class="function">test_filter_info_log_empty</span>():
    <span class="comment"># Given</span>
    logs = []
    rules = Rules()
    log_filter = LogFilter(rules)

    <span class="comment"># When</span>
    result = log_filter.filter_info_log(logs)

    <span class="comment"># Then</span>
    <span class="keyword">assert</span> result == []</code></pre></div></div></div></div>
<div class="openblock right-column"><div class="content"><div class="listingblock big"><div class="content"><pre class="CodeRay highlight"><code data-lang="python"><span class="keyword">def</span> <span class="function">test_filter_info_log_no_info_logs</span>():
    <span class="comment"># Given</span>
    logs = [Log(level=<span class="string"><span class="delimiter">&quot;</span><span class="content">ERROR</span><span class="delimiter">&quot;</span></span>)]
    rules = Rules()
    log_filter = LogFilter(rules)

    <span class="comment"># When</span>
    result = log_filter.filter_info_log(logs)

    <span class="comment"># Then</span>
    <span class="keyword">assert</span> result == []</code></pre></div></div></div></div></div></section><section id="_test_franchement_pas_facile"><h2>Test franchement pas facile</h2><div class="slide-content"><div class="paragraph"><p>Un filtre avec des r√®gles charg√©es depuis une base de donn√©es</p></div>
<div class="listingblock big"><div class="content"><pre class="CodeRay highlight"><code data-lang="python"><span class="keyword">class</span> <span class="class">LogFilter</span>:
    <span class="keyword">def</span> <span class="function">__init__</span>(<span class="predefined-constant">self</span>, rules: Rules):
        <span class="predefined-constant">self</span>.rules = rules
    ...

<span class="keyword">class</span> <span class="class">Rules</span>:
    <span class="keyword">def</span> <span class="function">__init__</span>(<span class="predefined-constant">self</span>, db_name: <span class="predefined">str</span>, db_host: <span class="predefined">str</span>, db_login: <span class="predefined">str</span>, db_password: <span class="predefined">str</span>):
        <span class="predefined-constant">self</span>. conn = psycopg2.connect(database = db_name,
                                        user = db_login,
                                        host= db_host,
                                        password = db_password)

        <span class="predefined-constant">self</span>.load_rules(<span class="predefined-constant">self</span>.conn)</code></pre></div></div>
<div class="openblock left-column"><div class="content"><div class="listingblock big"><div class="content"><pre class="CodeRay highlight"><code data-lang="python"><span class="keyword">def</span> <span class="function">test_filter_info_log_empty</span>():
    <span class="comment"># Given</span>
    conn = psycopg2.connect(database = TEST_DATABASE,
                            user = TEST_USER,
                            host= TEST_HOST,
                            password = TEST_PASSWORD,
                            port = <span class="integer">5432</span>)
    clear_then_load_rules_in_database(conn)

    logs = []
    rules = Rules(conn)
    log_filter = LogFilter(rules)

    <span class="comment"># When</span>
    result = log_filter.filter_info_log(logs)

    <span class="comment"># Then</span>
    <span class="keyword">assert</span> result == []</code></pre></div></div></div></div>
<div class="openblock right-column"><div class="content"><div class="listingblock big"><div class="content"><pre class="CodeRay highlight"><code data-lang="python"><span class="keyword">def</span> <span class="function">test_filter_info_log_no_info_logs</span>():
    <span class="comment"># Given</span>
    conn = psycopg2.connect(database = TEST_DATABASE,
                            user = TEST_USER,
                            host= TEST_HOST,
                            password = TEST_PASSWORD,
                            port = <span class="integer">5432</span>)
    clear_then_load_rules_in_database(conn)

    logs = [Log(level=<span class="string"><span class="delimiter">&quot;</span><span class="content">ERROR</span><span class="delimiter">&quot;</span></span>)]
    rules = Rules(conn)
    log_filter = LogFilter(rules)

    <span class="comment"># When</span>
    result = log_filter.filter_info_log(logs)

    <span class="comment"># Then</span>
    <span class="keyword">assert</span> result == []</code></pre></div></div></div></div></div></section><section id="_facilit√©_et_couplage"><h2>Facilit√© et couplage</h2><div class="slide-content"><div class="openblock left-column"><div class="content"><div class="ulist"><ul><li class="fragment"><p>Coupable couplage</p><div class="ulist"><ul><li><p>Mise en condition &#8658; beaucoup de travail</p><div class="ulist"><ul><li><p>&#8658; Instanciation de nombreux objets</p></li><li><p>&#8658; Beaucoup de pr√©occupation diff√©rentes</p></li></ul></div></li></ul></div></li><li class="fragment"><p>Objectifs de la refactorisation</p><div class="ulist"><ul><li><p>&#8658; D√©coupler au maximum</p><div class="ulist"><ul><li><p>Conception <em>propre</em> &#8656; R√©duction dette</p></li></ul></div></li><li><p>&#8658; Se lib√©rer des d√©pendances</p><div class="ulist"><ul><li><p>Plusieurs strat√©gies selon contexte</p></li></ul></div></li></ul></div></li></ul></div></div></div>
<div class="openblock right-column"><div class="content"><div class="ulist"><ul><li class="fragment"><p>Action pr√©ventives</p><div class="ulist"><ul><li><p>&#8658; Nouveau code  &#8594; nouveau test</p></li></ul></div></li><li class="fragment"><p>Action correctives</p><div class="ulist"><ul><li><p>&#8658; Legacy code &#8594; Euh, une autre histoire</p></li></ul></div></li></ul></div></div></div></div></section><section id="_mocking"><h2>Mocking</h2><div class="slide-content"><div class="openblock left-column-2-3"><div class="content"><div class="ulist"><ul><li class="fragment"><p>Situation complexe &#8658; Mocking</p><div class="ulist"><ul><li><p>Mock &#8658; objet simul√© qui <strong>imite</strong> le comportement d&#8217;objets r√©els de mani√®re <em>contr√¥l√©e</em>.</p></li><li><p>Outil tr√®s puissants et utiles</p><div class="ulist"><ul><li><p>Simuler un composant</p></li><li><p>Espionner les appels √† un composant</p></li><li><p>Cr√©ation d&#8217;un objet virtuel uniquement pour les tests</p></li></ul></div></li></ul></div></li><li class="fragment"><p>Outil pas toujours simples</p><div class="ulist"><ul><li><p><em>Quand m√™me mocker devient compliqu√©</em> &#8658; S√©rieux probl√®me de conception.</p></li></ul></div></li></ul></div></div></div>
<div class="openblock right-column-1-3"><div class="content"><div class="imageblock right"><img src="https://media.giphy.com/media/C3YUQjB5agrdK/giphy.gif" alt="giphy"></div></div></div></div></section><section id="_mocking_harry_potdefleur" class="black background center"><h2>Mocking &gt; Harry PotDeFleur</h2><div class="slide-content"><div class="paragraph"><p>Trop facile de se sortir d&#8217;une mauvaise situation par mauvaise conception.</p></div>
<div class="imageblock center"><img src="../images/harrypotter.jpg" alt="harrypotter"></div></div></section></section>
<section><section id="_mocking_python_en_30_secondes"><h2>Mocking Python en 30 secondes</h2><div class="slide-content"><div class="ulist"><ul><li><p>Simple illustration</p><div class="ulist"><ul><li><p>Python <code>unittest.mock.Mock</code></p></li></ul></div></li><li><p>Pour plus de d√©tails</p><div class="ulist"><ul><li><p>Mockito pour java <a href="https://site.mockito.org/" class="bare">https://site.mockito.org/</a></p></li><li><p>Mocking avec Pytest <a href="https://github.com/Euclid-Python/Python-pytest/blob/master/pytest-mock.ipynb" target="_blank">Euclid-Python/Python-pytest</a></p></li></ul></div></li></ul></div></div></section><section id="_mock_the_callable_box"><h2>Mock &gt; The Callable Box</h2><div class="slide-content"><div class="paragraph center"><p><strong>Mock, la bo√Æte √† invocations</strong></p></div>
<div class="paragraph"><p>Un <code>Mock</code> est une <em>fonction</em> qui renvoie <em>toujours</em> un autre <code>Mock</code>.</p></div>
<div class="openblock left-column"><div class="content"><div class="listingblock big"><div class="content"><pre class="CodeRay highlight"><code data-lang="python">mock = Mock()

foo = mock.foo()

<span class="keyword">assert</span> <span class="predefined">isinstance</span>(foo(), Mock)</code></pre></div></div></div></div>
<div class="openblock right-column"><div class="content"><div class="listingblock big"><div class="content"><pre class="CodeRay highlight"><code data-lang="python">mock = Mock()

result = mock.n().o().p().q().r().s().some_method()

<span class="keyword">assert</span> <span class="predefined">isinstance</span>(result, Mock)</code></pre></div></div></div></div></div></section><section id="_mock_return_value_et_side_effect"><h2>Mock &gt; return_value et side_effect</h2><div class="slide-content"><div class="ulist"><ul><li><p>Simulation des valeurs √† renvoyer</p></li><li><p><code>return_value</code></p><div class="ulist"><ul><li><p>&#8658; valeur <em>unique</em> √† renvoyer pour tout appel</p></li></ul></div></li></ul></div>
<div class="listingblock big"><div class="content"><pre class="CodeRay highlight"><code data-lang="python">mock = Mock()

mock.some_method.return_value = <span class="string"><span class="delimiter">'</span><span class="content">A</span><span class="delimiter">'</span></span>

<span class="keyword">assert</span> [mock.some_method() <span class="keyword">for</span> _ <span class="keyword">in</span> <span class="predefined">range</span>(<span class="integer">3</span>)] == [<span class="string"><span class="delimiter">'</span><span class="content">A</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">A</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">A</span><span class="delimiter">'</span></span>]</code></pre></div></div>
<div class="ulist"><ul><li><p><code>side_effect</code></p><div class="ulist"><ul><li><p>&#8658; S√©quence de valeurs √† associer √† une s√©quence d&#8217;appels</p></li></ul></div></li></ul></div>
<div class="listingblock big"><div class="content"><pre class="CodeRay highlight"><code data-lang="python">mock = Mock()

mock.some_method.side_effect = <span class="string"><span class="delimiter">'</span><span class="content">A</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">B</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">C</span><span class="delimiter">'</span></span>

<span class="keyword">assert</span> [mock.some_method() <span class="keyword">for</span> _ <span class="keyword">in</span> <span class="predefined">range</span>(<span class="integer">3</span>)] == [<span class="string"><span class="delimiter">'</span><span class="content">A</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">B</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">C</span><span class="delimiter">'</span></span>]</code></pre></div></div></div></section><section id="_mock_the_recording_box"><h2>Mock &gt; The Recording Box</h2><div class="slide-content"><div class="paragraph center"><p><strong>Mock, la bo√Æte √† enregistrer</strong></p></div>
<div class="paragraph"><p>Espionner les appels de m√©thodes</p></div>
<div class="openblock"><div class="content"><div class="listingblock big"><div class="content"><pre class="CodeRay highlight"><code data-lang="python">mock = Mock()
mock.some_method.return_value = <span class="string"><span class="delimiter">'</span><span class="content">foo</span><span class="delimiter">'</span></span>

mock.some_method()
mock.some_method.assert_called_once() <span class="comment"># &lt;-- assert been called one time</span>

mock.some_method()
<span class="keyword">assert</span> mock.some_method.call_count == <span class="integer">2</span> <span class="comment"># &lt;-- assert been called two times</span></code></pre></div></div></div></div>
<div class="paragraph"><p>Plusieurs possibilit√©s</p></div>
<div class="openblock"><div class="content"><div class="listingblock big"><div class="content"><pre>assert_any_call
assert_called
assert_called_once
assert_called_once_with
assert_called_with
assert_has_calls
assert_not_called
attach_mock
call_args
call_args_list
call_count
called</pre></div></div></div></div>
<div class="paragraph"><p>Voir la documentation
<span class="smaller"><a href="https://docs.python.org/3/library/unittest.mock.html" class="bare">https://docs.python.org/3/library/unittest.mock.html</a></span></p></div></div></section></section>
<section><section id="_legacy" class="black background center"><h2>Legacy</h2><div class="slide-content"><div class="imageblock"><img src="../images/wikipedia_Bennett_College,_Millbrook_NY.jpg" alt="wikipedia Bennett College, Millbrook NY"></div><div class="ulist"><ul><li class="fragment"><p>Le mur de la r√©alit√©</p></li></ul></div></div></section><section id="_legacy_2" class="center"><h2>Legacy</h2><div class="slide-content"><div class="sidebarblock"><div class="content"><div class="paragraph"><p>Code ancien, au fonctionnement myst√©rieux, dont l‚Äô√©volution semble d√©licate.</p></div></div></div>
<div class="openblock fragment"><div class="content"><div class="sidebarblock"><div class="content"><div class="paragraph"><p>Code que vous n&#8217;√™tes pas pr√™t √† modifier</p></div></div></div></div></div></div></section></section>
<section><section id="_legacy_et_testabilit√©"><h2>Legacy et testabilit√©</h2><div class="slide-content"><div class="quoteblock"><blockquote><div class="paragraph"><p>Code without tests is <strong>bad</strong> code.<br></p></div>
<div class="paragraph"><p>It doesn&#8217;t matter how well written it is;<br>
it doesn&#8217;t matter how pretty<br>
or object-oriented or well-encapsulated it is.</p></div>
<div class="paragraph"><p><strong>With tests, we can change </strong><br>
the behavior of our code quickly and verifiably.</p></div>
<div class="paragraph"><p><strong>Without them, we really don&#8217;t know </strong><br>
if our code is getting better or worse.</p></div></blockquote><div class="attribution">&#8212; Michael C. Feathers</div></div></div></section><section id="_le_cercle_infernale"><h2>Le cercle infernale</h2><div class="slide-content"><div class="imageblock center"><img src="../images/testability-cercle.svg" alt="alt"></div></div></section><section id="_obstacles_√†_la_testabilit√©"><h2>Obstacles √† la testabilit√©</h2><div class="slide-content"><div class="sidebarblock center"><div class="content"><div class="paragraph"><p>Obstacles aux tests <em>unitaires</em></p></div></div></div>
<div class="ulist"><ul><li class="fragment"><p>D√©pendances trop lourdes ou complexes</p><div class="ulist"><ul><li><p>Base de donn√©es, Web Services ext√©rieurs, Librairies tierces</p></li><li><p><em>Science</em> &#8658; √âquipement, Carte √©lectronique, Instrument</p></li><li><p>Arbre de d√©pendances trop profond</p></li></ul></div></li><li class="fragment"><p>Tests non idempotents</p><div class="ulist"><ul><li><p>Li√©es au temps, gestion asynchrone, randomisation</p></li></ul></div></li><li class="fragment"><p>Absence d&#8217;observable</p><div class="ulist"><ul><li><p>Pas de changement d&#8217;√©tat, pas de retour, pas de son, pas d&#8217;image</p></li></ul></div></li></ul></div>
<aside class="notes"><div class="ulist"><ul><li><p>La mise en oeuvre demande des ressources consid√©rables qui vont au del√† des moyen du d√©veloppeur</p><div class="ulist"><ul><li><p>Monter une base de donn√©es, un site ext√©rieur</p></li></ul></div></li><li><p>Les tests ne sont pas r√©p√©tables car ils d√©pendent de choses qui sont trop fluctuantes</p><div class="ulist"><ul><li><p>Heure, propri√©t√©s syst√®me, randomisation</p></li></ul></div></li><li><p>Je ne peux rien observer, aucun moyen de savoir si il s&#8217;est pass√©e quelque chose.</p></li></ul></div></aside></div></section><section id="_chirurgie_de_guerre"><h2>Chirurgie de guerre</h2><div class="slide-content"><div class="ulist"><ul><li class="fragment"><p>Tester co√ªte que co√ªte</p><div class="ulist"><ul><li><p>&#8658; Renoncer temporairement √† un id√©al de conception</p></li><li><p>&#8658; Constater la conservation des comportements</p></li></ul></div></li><li class="fragment"><p>Tout est autoris√© ou presque</p><div class="ulist"><ul><li><p>Mettre une variable t√©moin</p></li><li><p>Transgresser les principes de conception</p></li></ul></div></li></ul></div>
<div class="sidebarblock fragment"><div class="content"><div class="paragraph"><p>Ce qui compte est de savoir ce que fait <strong>r√©ellement</strong> le code, avant de l&#8217;am√©liorer</p></div></div></div></div></section><section id="_test_de_caract√©risation"><h2>Test de caract√©risation</h2><div class="slide-content"><div class="ulist"><ul><li><p>Prendre un clich√© du comportement actuel</p></li><li><p>Test par approbation</p><div class="ulist"><ul><li><p>Test <em>ext√©rieur</em></p></li><li><p>Comparaison avec un r√©sultat <strong>approuv√©</strong> conserv√© sous forme de <strong>fichier</strong></p></li><li><p>Fichier qui peut √™tre <em>fourni</em> par la cliente ou le client !!</p></li></ul></div></li><li><p>R√©f√©rence</p></li></ul></div>
<div class="openblock center"><div class="content"><div class="paragraph"><p><a href="https://approvaltests.com/" target="_blank">https://approvaltests.com/</a></p></div>
<div class="sidebarblock"><div class="content"><div class="paragraph"><p>Given &#8594; When &#8594; Then &#8594; Verify</p></div></div></div></div></div></div></section><section id="_test_de_caract√©risation_exemple"><h2>Test de caract√©risation &gt; Exemple</h2><div class="slide-content"><div class="imageblock center"><img src="../images/testability-approval.svg" alt="testability approval"></div></div></section><section id="_test_de_caract√©risation_exemple_2"><h2>Test de caract√©risation &gt; Exemple</h2><div class="slide-content"><div class="openblock left-column"><div class="content"><div class="listingblock big"><div class="content"><pre class="CodeRay highlight"><code data-lang="python"><span class="decorator">@dataclass</span>
<span class="keyword">class</span> <span class="class">City</span>:
    name: <span class="predefined">str</span>


<span class="decorator">@dataclass</span>
<span class="keyword">class</span> <span class="class">Address</span>:
    street: <span class="predefined">str</span>
    city: City</code></pre></div></div></div></div>
<div class="openblock right-column"><div class="content"><div class="listingblock big"><div class="content"><pre class="CodeRay highlight"><code data-lang="python"><span class="decorator">@dataclass</span>
<span class="keyword">class</span> <span class="class">Person</span>:
    name: <span class="predefined">str</span>
    age: <span class="predefined">int</span>
    address: Optional[Address] = <span class="predefined-constant">None</span>
    knows: List[Person] = field(default_factory=<span class="predefined">list</span>)

    <span class="keyword">def</span> <span class="function">add_relation</span>(<span class="predefined-constant">self</span>, relation: Person):
        <span class="predefined-constant">self</span>.knows.append(relation)



<span class="decorator">@dataclass</span>
<span class="keyword">class</span> <span class="class">Family</span>:
    name: <span class="predefined">str</span>
    members: List[Person] = field(default_factory=<span class="predefined">list</span>)</code></pre></div></div></div></div>
<div class="openblock reset-column"><div class="content"><div class="listingblock big"><div class="content"><pre class="CodeRay highlight"><code data-lang="python"><span class="keyword">def</span> <span class="function">find_related_people_in_same_cities</span>(families: List[Family]):
    people_relations_by_cities = {}
    <span class="keyword">for</span> family <span class="keyword">in</span> families:
        <span class="keyword">for</span> people <span class="keyword">in</span> family.members:
            <span class="keyword">if</span> people.knows:
                city_name = people.address.city.name
                relations = people_relations_by_cities.get(city_name)
                <span class="keyword">if</span> <span class="keyword">not</span> relations:
                    relations = []
                    people_relations_by_cities[city_name] = relations
                relations.append(people)
    <span class="keyword">return</span> people_relations_by_cities</code></pre></div></div></div></div></div></section><section id="_test_de_caract√©risation_exemple_3"><h2>Test de caract√©risation &gt; Exemple</h2><div class="slide-content"><div class="paragraph"><p>Test avec approval</p></div>
<div class="listingblock big"><div class="content"><pre class="CodeRay highlight"><code data-lang="python"><span class="keyword">from</span> <span class="include">approvaltests.approvals</span> <span class="keyword">import</span> <span class="include">verify</span>

<span class="keyword">def</span> <span class="function">test_approval</span>():
    <span class="comment"># ___ GIVEN ____</span>
    city = City(name=<span class="string"><span class="delimiter">'</span><span class="content">Sample City</span><span class="delimiter">'</span></span>)

    alice = Person(name=<span class="string"><span class="delimiter">'</span><span class="content">Alice</span><span class="delimiter">'</span></span>, age=<span class="integer">25</span>, address=Address(street=<span class="string"><span class="delimiter">'</span><span class="content">123 Street A</span><span class="delimiter">'</span></span>, city=city))
    bob = Person(name=<span class="string"><span class="delimiter">'</span><span class="content">Bob</span><span class="delimiter">'</span></span>, age=<span class="integer">30</span>, address=Address(street=<span class="string"><span class="delimiter">'</span><span class="content">456 Street B</span><span class="delimiter">'</span></span>, city=city))
    family1 = Family(name=<span class="string"><span class="delimiter">'</span><span class="content">Smith</span><span class="delimiter">'</span></span>, members=[alice, bob])
    charlie = Person(name=<span class="string"><span class="delimiter">'</span><span class="content">Charlie</span><span class="delimiter">'</span></span>, age=<span class="integer">28</span>, address=Address(street=<span class="string"><span class="delimiter">'</span><span class="content">789 Street C</span><span class="delimiter">'</span></span>, city=city))
    family2 = Family(name=<span class="string"><span class="delimiter">'</span><span class="content">Johnson</span><span class="delimiter">'</span></span>, members=[charlie])

    alice.knows.append(charlie)

    <span class="comment"># ___ WHEN ____</span>
    related_people = find_related_people_in_same_cities([family1, family2])

    <span class="comment"># ___ THEN ____</span>
    verify(related_people)</code></pre></div></div></div></section><section id="_test_de_caract√©risation_exemple_4"><h2>Test de caract√©risation &gt; Exemple</h2><div class="slide-content"><div class="paragraph"><p>Lancement avec</p></div>
<div class="listingblock big"><div class="content"><pre class="CodeRay highlight"><code data-lang="bash">pytest --approvaltests-use-reporter='PythonNativeReporter'</code></pre></div></div>
<div class="paragraph"><p>Dans <code>Pycharm</code></p></div>
<div class="paragraph center"><p><span class="image"><img src="../images/capture_approval_1.png" alt="capture approval 1"></span></p></div></div></section><section id="_test_de_caract√©risation_exemple_5"><h2>Test de caract√©risation &gt; Exemple</h2><div class="slide-content"><div class="paragraph"><p>Sortie du test en √©chec</p></div>
<div class="listingblock"><div class="content"><pre class="CodeRay highlight"><code data-lang="text">to approve this result:

move &quot;/home/mdexet/approval_demo/tests/test_prettyworld.test_approval.received.txt&quot;
 &quot;/home/mdexet/approval_demo/tests/test_prettyworld.test_approval.approved.txt&quot;

...
code&gt;       verify(related_people)
E       approvaltests.approval_exception.ApprovalException: Approval Mismatch, received != approved
E               Approved: /home/mdexet/approval_demo/tests/test_prettyworld.test_approval.approved.txt
E               Received: /home/mdexet/approval_demo/tests/test_prettyworld.test_approval.received.txt</code></pre></div></div>
<div class="paragraph"><p>Dans PyCharm</p></div>
<div class="paragraph center"><p><span class="image"><img src="../images/capture_approval_0.png" alt="capture approval 0" width="500"></span></p></div></div></section><section id="_test_de_caract√©risation_exemple_6"><h2>Test de caract√©risation &gt; Exemple</h2><div class="slide-content"><div class="paragraph"><p>Contenu du fichier de r√©f√©rence <code>test_prettyworld.test_approval.approved.txt</code></p></div>
<div class="listingblock big"><div class="content"><pre class="CodeRay highlight"><code data-lang="text">{'Sample City': [Person(name='Alice', age=25, address=Address(street='123 Street A', city=City(name='Sample City')),
  knows=[Person(name='Charlie', age=28, address=Address(street='789 Street C', city=City(name='Sample City')), knows=[])])]}</code></pre></div></div></div></section><section id="_test_de_caract√©risation_exemple_7"><h2>Test de caract√©risation &gt; Exemple</h2><div class="slide-content"><div class="paragraph"><p>D√®s que le fichier est copi√©, le test est valid√©.
En cas de d√©viation, que ce passe-t-il ?</p></div>
<div class="listingblock big"><div class="content"><pre class="CodeRay highlight"><code data-lang="text">tests\test_prettyworld.py:24: ApprovalException
-------------------------------- Captured stdout call ---------------------------------
--- test_prettyworld.test_approval.approved.txt
+++ test_prettyworld.test_approval.received.txt
@@ -1 +1 @@
-{'Sample City': [Person(name='AliceFOO', age=25, address=Address(street='123 Street A', city=City(name='Sample City')),
 knows=[Person(name='Charlie', age=28, address=Address(street='789 Street C', city=City(name='Sample City')), knows=[])])]}
+{'Sample City': [Person(name='Alice', age=25, address=Address(street='123 Street A', city=City(name='Sample City')),
 knows=[Person(name='Charlie', age=28, address=Address(street='789 Street C', city=City(name='Sample City')), knows=[])])]}</code></pre></div></div>
<div class="paragraph"><p>Avec <code>WinMerge</code> sous Windows</p></div>
<div class="imageblock center"><img src="../images/capture_approval_winmerge.png" alt="alt"></div></div></section><section id="_test_de_caract√©risation_exemple_8"><h2>Test de caract√©risation &gt; Exemple</h2><div class="slide-content"><div class="ulist"><ul><li><p>Date ?</p><div class="ulist"><ul><li><p>&#8658; Scrubber (<em>Laveur</em>) :  Remplace dates par placeholder <code>date${n}</code></p></li></ul></div></li></ul></div>
<div class="openblock left-column-1-3"><div class="content"><div class="listingblock"><div class="content"><pre class="CodeRay highlight"><code data-lang="python"><span class="decorator">@dataclass</span>
<span class="keyword">class</span> <span class="class">DatedNote</span>:
    note: <span class="predefined">str</span>
    date : datetime

    <span class="keyword">def</span> <span class="function">merge</span>(<span class="predefined-constant">self</span>, o: DatedNote):
        <span class="predefined-constant">self</span>.note = f<span class="string"><span class="delimiter">'</span><span class="content">{self.note}/{o.note}</span><span class="delimiter">'</span></span>
        d = <span class="predefined">max</span>(<span class="predefined-constant">self</span>.date, o.date)
        <span class="predefined-constant">self</span>.date =d</code></pre></div></div></div></div>
<div class="openblock right-column-2-3"><div class="content"><div class="listingblock"><div class="content"><pre class="CodeRay highlight"><code data-lang="python"><span class="keyword">def</span> <span class="function">test_with_date_scrubbers</span>():
    <span class="comment"># --Given--</span>
    <span class="comment"># Create 2 hours spaced datetime</span>
    now = datetime.now()
    later = now + timedelta(hours=<span class="integer">2</span>)

    <span class="comment"># Assign them to different notes</span>
    dated_note0 = DatedNote(<span class="string"><span class="delimiter">&quot;</span><span class="content">Foo</span><span class="delimiter">&quot;</span></span>, now)
    dated_note1 = DatedNote(<span class="string"><span class="delimiter">&quot;</span><span class="content">Bar</span><span class="delimiter">&quot;</span></span>, later)

    <span class="comment"># Ad hoc reporter</span>
    <span class="keyword">def</span> <span class="function">as_report</span>(note: DatedNote):
        <span class="keyword">return</span> f<span class="string"><span class="delimiter">'</span><span class="content">NOTE:{note.note}, DATE={note.date.strftime(&quot;%Y%m%dT%H%M%SZ&quot;)}</span><span class="delimiter">'</span></span>

    <span class="comment"># --When--</span>
    dated_note1.merge(dated_note0)
    <span class="comment"># --Then--</span>
    verify(as_report(dated_note1),
            options=Options().with_scrubber(
                DateScrubber.get_scrubber_for(<span class="string"><span class="delimiter">&quot;</span><span class="content">00000000T000000Z</span><span class="delimiter">&quot;</span></span>)))</code></pre></div></div></div></div>
<div class="openblock reset-column"><div class="content"><div class="listingblock"><div class="content"><pre class="CodeRay highlight"><code data-lang="text">NOTE:Bar/Foo, DATE=&lt;date0&gt;</code></pre></div></div></div></div></div></section><section id="_obstacles_typiques"><h2>Obstacles typiques</h2><div class="slide-content"><div class="ulist"><ul><li><p>La d√©pendance irritante</p></li><li><p>L&#8217;instanciation cach√©e</p></li><li><p>Le Singleton</p></li><li><p>Les boucles imbriqu√©es</p></li></ul></div>
<div class="paragraph"><p>TODO V√©rifie coh√©rence Raison de la difficult√© √† tester</p></div></div></section><section id="_obstacle_le_param√®tre_irritant"><h2>Obstacle &gt; Le param√®tre irritant</h2><div class="slide-content"><div class="paragraph"><p>Exemple avec une base de donn√©e en param√®tre</p></div>
<div class="listingblock big"><div class="content"><pre class="CodeRay highlight"><code data-lang="python"><span class="keyword">class</span> <span class="class">Validator</span>:

    <span class="keyword">def</span> <span class="function">__init__</span>(<span class="predefined-constant">self</span>, conn: connection)
        <span class="docstring"><span class="delimiter">&quot;&quot;&quot;</span><span class="content">
</span><span class="content">        :param conn: psycopg2 connection</span><span class="content">
</span><span class="content">        </span><span class="delimiter">&quot;&quot;&quot;</span></span>
        ...

    <span class="keyword">def</span> <span class="function">validate</span>(<span class="predefined-constant">self</span>, msg: Message):
        ...
    <span class="keyword">def</span> <span class="function">load_rules</span>(<span class="predefined-constant">self</span>, conn: connection):
        ...</code></pre></div></div></div></section><section id="_obstacle_le_param√®tre_irritant_2"><h2>Obstacle &gt; Le param√®tre irritant</h2><div class="slide-content"><div class="paragraph"><p>Test lourd √† mettre en oeuvre: base n√©cessaire</p></div>
<div class="listingblock big"><div class="content"><pre class="CodeRay highlight"><code data-lang="python"><span class="keyword">def</span> <span class="function">test_validator_load_rules</span>():
    <span class="comment"># Given</span>
    conn = psycopg2.connect(database = TEST_DATABASE,
                            user = TEST_USER,
                            host= TEST_HOST,
                            password = TEST_PASSWORD,
                            port = <span class="integer">5432</span>)
    clear_then_load_rules_in_database(conn)

    validator = Validator(conn=conn)
    message = Message(id=<span class="integer">123</span>, content=f<span class="string"><span class="delimiter">'</span><span class="content">CONTACT server=nowhere.com</span><span class="delimiter">'</span></span>)


    <span class="comment"># When</span>
    is_valid = validator.validate(msg)


    <span class="comment"># Then</span>
    <span class="keyword">assert</span> is_valid</code></pre></div></div></div></section></section>
<section id="_obstacle_la_d√©pendance_cach√©e"><h2>Obstacle &gt; La d√©pendance cach√©e</h2><div class="slide-content"><div class="paragraph"><p>Pas vu, pas pris</p></div>
<div class="paragraph"><p>Utilisation cach√©e de <code>XBandTransmitter</code></p></div>
<div class="listingblock big"><div class="content"><pre class="CodeRay highlight"><code data-lang="python"><span class="keyword">class</span> <span class="class">RadioCommunicator</span>(Communicator):

    <span class="keyword">def</span> <span class="function">__init__</span>(<span class="predefined-constant">self</span>):
        <span class="predefined-constant">self</span>.transmitter = XBandTransmitter() <span class="comment">#&lt;--------------- Hidden !</span>

    <span class="keyword">def</span> <span class="function">send</span>(msg: Message) -&gt; <span class="predefined-constant">None</span>:
        <span class="keyword">if</span> <span class="keyword">not</span> <span class="predefined-constant">self</span>.check_compliance_with_very_complicated_rules(msg):
            <span class="keyword">return</span>

        channel: XBandChannel = <span class="predefined-constant">self</span>.transmitter.get_channel()
        channel.write(Message.to_base68(msg))
        channel.close()

    <span class="keyword">def</span> <span class="function">receive</span>(<span class="predefined-constant">self</span>) -&gt; Message:
        channel: XBandChannel = <span class="predefined-constant">self</span>.transmitter.get_channel()
        content = channel.read()
        <span class="keyword">if</span> content :
            <span class="keyword">return</span> Message.from_base68(content)
        channel.close()</code></pre></div></div>
<div class="paragraph"><p>Comment faire un test de <code>RadioCommunicator</code> alors que tout repose sur <code>XBandTransmitter</code> ?</p></div></div></section>
<section id="_obstacle_la_d√©pendance_cach√©e_2"><h2>Obstacle &gt; La d√©pendance cach√©e</h2><div class="slide-content"><div class="paragraph"><p><strong>Le probl√®me</strong></p></div>
<div class="ulist"><ul><li><p>Fort couplage</p><div class="ulist"><ul><li><p>Connaissance n√©cessaire hors domaine</p></li></ul></div></li><li><p>Difficult√© d&#8217;exploration</p><div class="ulist"><ul><li><p>Comment <em>disposer</em> la d√©pendance pour les tests</p></li></ul></div></li><li><p>Solution</p><div class="ulist"><ul><li><p><em>Reposer sur l&#8217;abstraction plut√¥t que l&#8217;impl√©mentation !</em></p></li></ul></div></li></ul></div>
<aside class="notes"><div class="paragraph"><p>La d√©pendance cach√©e traduit un probl√®me de conception qui concerne l&#8217;initialisation des objet.
La d√©pendance cach√©e peut cr√©er de s√©rieux probl√®mes de test, car nous ne savons pas forc√©ment, en tant que concepteur du <code>RadioCommunicator</code> tout ce que cela implique.
L&#8217;autre probl√®me concerne la connaissance, donc le couplage inh√©rent √† cette d√©pendance cach√©e.</p></div>
<div class="paragraph"><p>Le mieux est de reposer que l&#8217;abstraction plut√¥t que l&#8217;impl√©mentation.</p></div></aside></div></section>
<section><section id="_obstacle_la_d√©pendance_cach√©e_3"><h2>Obstacle &gt; La d√©pendance cach√©e</h2><div class="slide-content"><div class="paragraph"><p><strong>Extraire l&#8217;interface du XBandTransmitter</strong></p></div><div class="ulist"><ul><li><p><code>XBandTransmitter</code></p><div class="ulist"><ul><li><p>se limite √† obtenir un <code>XBandChannel</code></p></li></ul></div></li><li><p><code>XBandChannel</code></p><div class="ulist"><ul><li><p>se limite √† <em>√©crire</em>, <em>lire</em> et <em>se fermer</em>.</p></li></ul></div></li></ul></div><div class="paragraph"><p>&#8658; √âcrivons donc une interface <code>RadioTransmitter</code> et une interface <code>Channel</code></p></div><div class="openblock left-column"><div class="content"><div class="listingblock"><div class="content"><pre class="CodeRay highlight"><code data-lang="python"><span class="keyword">class</span> <span class="class">Channel</span>(Protocol):
    <span class="keyword">def</span> <span class="function">write</span>(<span class="predefined-constant">self</span>, content: <span class="predefined">str</span>):
        ...
    <span class="keyword">def</span> <span class="function">read</span>(<span class="predefined-constant">self</span>) -&gt; <span class="predefined">str</span> :
        ...
    <span class="keyword">def</span> <span class="function">close</span>(<span class="predefined-constant">self</span>):
        ...

<span class="keyword">class</span> <span class="class">RadioTransmitter</span>(Protocol):
    <span class="keyword">def</span> <span class="function">get_channel</span>(<span class="predefined-constant">self</span>) -&gt; Channel:
        ...</code></pre></div></div></div></div><div class="openblock right-column"><div class="content"><div class="listingblock"><div class="content"><pre class="CodeRay highlight"><code data-lang="python"><span class="keyword">class</span> <span class="class">RadioCommunicator</span>(Communicator):

    <span class="keyword">def</span> <span class="function">__init__</span>(<span class="predefined-constant">self</span>):
        <span class="predefined-constant">self</span>.transmitter: RadioTransmitter = XBandTransmitter()

    <span class="keyword">def</span> <span class="function">send</span>(msg: Message) -&gt; <span class="predefined-constant">None</span>:
        <span class="keyword">if</span> <span class="keyword">not</span> <span class="predefined-constant">self</span>.check_compliance_with_very_complicated_rules(msg):
            <span class="keyword">return</span>

        channel: Channel = <span class="predefined-constant">self</span>.transmitter.get_channel()
        channel.write(Message.to_base68(msg))
        channel.close()

    <span class="keyword">def</span> <span class="function">receive</span>(<span class="predefined-constant">self</span>) -&gt; Message:
        channel: Channel = <span class="predefined-constant">self</span>.transmitter.get_channel()
        content = channel.read()
        <span class="keyword">if</span> content :
            <span class="keyword">return</span> Message.from_base68(content)
        channel.close()</code></pre></div></div></div></div></div></section><section id="_obstacle_la_d√©pendance_cach√©e_4"><h2>Obstacle &gt; La d√©pendance cach√©e</h2><div class="slide-content"><div class="paragraph"><p><strong>Ajouter un param√®tre optionnel</strong></p></div>
<div class="paragraph"><p>Pattern de l&#8217;injection de d√©pendance.</p></div>
<div class="listingblock big"><div class="content"><pre class="CodeRay highlight"><code data-lang="python"><span class="keyword">class</span> <span class="class">RadioCommunicator</span>(Communicator):

    <span class="keyword">def</span> <span class="function">__init__</span>(<span class="predefined-constant">self</span>, transmitter: RadioTransmitter = <span class="predefined-constant">None</span>):
        <span class="predefined-constant">self</span>.transmitter: RadioTransmitter = transmitter
        <span class="keyword">if</span> <span class="predefined-constant">self</span>.transmitter <span class="keyword">is</span> <span class="predefined-constant">None</span>:
            <span class="predefined-constant">self</span>.transmitter = XBandTransmitter()
        ..</code></pre></div></div></div></section><section id="_obstacle_la_d√©pendance_cach√©e_5"><h2>Obstacle &gt; La d√©pendance cach√©e</h2><div class="slide-content"><div class="paragraph"><p><strong>Tester</strong></p></div>
<div class="listingblock"><div class="content"><pre class="CodeRay highlight"><code data-lang="python"><span class="comment"># Create Fake Channel</span>
<span class="keyword">class</span> <span class="class">FakeChannel</span>(Channel):
    <span class="keyword">def</span> <span class="function">__init__</span>(<span class="predefined-constant">self</span>):
        <span class="predefined-constant">self</span>.read_buffer = []
        <span class="predefined-constant">self</span>.write_buffer = []
        <span class="predefined-constant">self</span>.is_closed = <span class="predefined-constant">False</span>

    <span class="keyword">def</span> <span class="function">write</span>(<span class="predefined-constant">self</span>, content: <span class="predefined">str</span>):
        <span class="predefined-constant">self</span>.write_buffer.append(content)

    <span class="keyword">def</span> <span class="function">read</span>(<span class="predefined-constant">self</span>) -&gt; <span class="predefined">str</span> :
        <span class="keyword">return</span> <span class="predefined-constant">self</span>.read_buffer.pop()

    <span class="keyword">def</span> <span class="function">close</span>(<span class="predefined-constant">self</span>):
        <span class="predefined-constant">self</span>.closed = <span class="predefined-constant">True</span>

<span class="keyword">class</span> <span class="class">FakeTransmitter</span>(RadioTransmitter):
    <span class="keyword">def</span> <span class="function">__init__</span>(<span class="predefined-constant">self</span>, fake_channel: FakeChannel):
        <span class="predefined-constant">self</span>.fake_channel = fake_channel

    <span class="keyword">def</span> <span class="function">get_channel</span>(<span class="predefined-constant">self</span>) -&gt; Channel:
        <span class="keyword">return</span> <span class="predefined-constant">self</span>.fake_channel</code></pre></div></div>
<div class="listingblock"><div class="content"><pre class="CodeRay highlight"><code data-lang="python"><span class="keyword">def</span> <span class="function">test_send_message</span>():
    <span class="comment"># Given</span>
    fake_channel = FakeChannel()
    fake_transmitter = FakeTransmitter(fake_channel)
    message = Message(id=<span class="integer">123</span>, content=f<span class="string"><span class="delimiter">'</span><span class="content">CONTACT server=nowhere.com</span><span class="delimiter">'</span></span>)


    <span class="comment"># When</span>
    communicator = RadioCommunicator(transmitter=fake_transmitter)
    communicator.send(message)


    <span class="comment"># Then</span>
    <span class="keyword">assert</span> <span class="predefined">len</span>(fake_channel.write_buffer) &gt; <span class="integer">0</span></code></pre></div></div></div></section><section id="_obstacle_la_d√©pendance_globale"><h2>Obstacle &gt; La d√©pendance globale</h2><div class="slide-content"><div class="ulist"><ul><li><p>Pattern du <code>Singleton</code></p><div class="ulist"><ul><li><p>D√©pendance √† un acc√®s au niveau classe <code>MessagesCollector.get_messages()</code>.</p></li></ul></div></li></ul></div>
<div class="listingblock"><div class="content"><pre class="CodeRay highlight"><code data-lang="python"><span class="keyword">class</span> <span class="class">ReportStream</span>:

    <span class="keyword">def</span> <span class="function">__init__</span>(<span class="predefined-constant">self</span>, out: IO[<span class="predefined">str</span>])
        <span class="predefined-constant">self</span>.out = out

    <span class="keyword">def</span> <span class="function">report_last_messages</span>(<span class="predefined-constant">self</span>):
        messages = MessagesCollector.get_messages()
        <span class="keyword">if</span> <span class="keyword">not</span> messages:
            <span class="keyword">return</span>
        <span class="keyword">for</span> message <span class="keyword">in</span> messages:
            out.write(f<span class="string"><span class="delimiter">'</span><span class="content">ID:{message.id} =&gt; {message.content}</span><span class="delimiter">'</span></span>)</code></pre></div></div>
<div class="paragraph"><p>Il est tr√®s difficile de la tester ainsi.
C&#8217;est possible, mais cela doit √™tre laborieux.</p></div></div></section><section id="_singleton_is_an_anti_pattern"><h2>Singleton is an anti-pattern</h2><div class="slide-content"><div class="ulist"><ul><li><p>Singleton pattern du <em>Gang Of Four</em></p><div class="ulist"><ul><li><p>S&#8217;assurer qu&#8217;une seule instance qui puisse exister.</p></li></ul></div></li><li><p>Anti-pattern</p><div class="ulist"><ul><li><p>Difficile √† adapter aux diff√©rentes situations</p></li><li><p>Tr√®s fort couplage √† une classe</p></li><li><p>Un changement impact tout le syst√®me</p><div class="ulist"><ul><li><p>&#8658; Aucune isolation :(</p></li></ul></div></li></ul></div></li></ul></div></div></section><section id="_obstacle_la_d√©pendance_globale_2"><h2>Obstacle &gt; La d√©pendance globale</h2><div class="slide-content"><div class="ulist"><ul><li><p>Analyse</p><div class="ulist"><ul><li><p><code>ReportStream</code> tr√®s fortement coupl√©e √† <code>MessagesCollector</code></p></li><li><p>Besoin &#8594; obtenir des √©v√®nements</p></li></ul></div></li><li><p>Solution</p><div class="ulist"><ul><li><p>Abstraction (as ever)</p></li><li><p>Segregation Of Interface</p><div class="ulist"><ul><li><p>Responsabilit√© &#8658; Fournir des √©v√®nements</p></li></ul></div></li><li><p>Injection de l&#8217;abstraction</p></li></ul></div></li></ul></div>
<div class="listingblock big"><div class="content"><pre class="CodeRay highlight"><code data-lang="python"><span class="keyword">class</span> <span class="class">MessageProvider</span>(Protocol):

    <span class="keyword">def</span> <span class="function">get_messages</span>(<span class="predefined-constant">self</span>) -&gt; <span class="predefined">list</span>[Message]:
        ...</code></pre></div></div></div></section><section id="_obstacle_la_d√©pendance_globale_3"><h2>Obstacle &gt; La d√©pendance globale</h2><div class="slide-content"><div class="paragraph"><p><strong>Travail sur le Singleton</strong></p></div>
<div class="ulist"><ul><li><p>Modifier <code>MessagesCollector</code></p><div class="ulist"><ul><li><p>Lui faire endosser l&#8217;interface <code>MessageProvider</code></p></li><li><p>Lui faire retourner via un <code>get()</code> lui m√™me</p></li><li><p>Permettre la modification via un <code>set()</code></p></li><li><p>Transformer la m√©thode de classe en m√©thode d&#8217;instance</p></li></ul></div></li></ul></div>
<div class="openblock left-column"><div class="content"><div class="listingblock"><div class="content"><pre class="CodeRay highlight"><code data-lang="python"><span class="keyword">class</span> <span class="class">MessagesCollector</span>(MessageProvider):

    instance = MessagesCollector()

    <span class="decorator">@classmethod</span>
    <span class="keyword">def</span> <span class="function">get</span>(cls, <span class="predefined-constant">self</span>):
        <span class="keyword">return</span> cls.instance

    <span class="decorator">@classmethod</span>
    <span class="keyword">def</span> <span class="function">set</span>(cls, provider: MessageProvider):
        cls.instance = provider

    <span class="keyword">def</span> <span class="function">get_messages</span>(cls):
        ...</code></pre></div></div></div></div>
<div class="openblock right-column"><div class="content"><div class="listingblock"><div class="content"><pre class="CodeRay highlight"><code data-lang="python"><span class="keyword">class</span> <span class="class">ReportStream</span>:

    <span class="keyword">def</span> <span class="function">__init__</span>(<span class="predefined-constant">self</span>, out: IO[<span class="predefined">str</span>])
        <span class="predefined-constant">self</span>.out = out

    <span class="keyword">def</span> <span class="function">report_last_messages</span>(<span class="predefined-constant">self</span>):
        messages = MessagesCollector.get().get_messages()
        <span class="keyword">if</span> <span class="keyword">not</span> messages:
            <span class="keyword">return</span>
        <span class="keyword">for</span> message <span class="keyword">in</span> messages:
            out.write(f<span class="string"><span class="delimiter">'</span><span class="content">ID:{message.id} =&gt; {message.content}</span><span class="delimiter">'</span></span>)</code></pre></div></div></div></div></div></section><section id="_test_en_modifiant_le_singleton"><h2>Test en modifiant le Singleton</h2><div class="slide-content"><div class="openblock left-column"><div class="content"><div class="listingblock"><div class="content"><pre class="CodeRay highlight"><code data-lang="python"><span class="decorator">@pytest.fixture</span>
<span class="keyword">def</span> <span class="function">message_provider</span>():
    <span class="keyword">class</span> <span class="class">FakeMessageProvider</span>(MessageProvider):
        <span class="keyword">def</span> <span class="function">__init__</span>(<span class="predefined-constant">self</span>):
            <span class="predefined-constant">self</span>.messages = []

        <span class="keyword">def</span> <span class="function">get_messages</span>(<span class="predefined-constant">self</span>) -&gt; <span class="predefined">list</span>[Message]:
            <span class="keyword">return</span> <span class="predefined-constant">self</span>.messages

    <span class="comment"># Set Up</span>
    fake_provider = FakeMessageProvider()
    instance = MessagesCollector.get()
    MessagesCollector.set(fake_provider)

    <span class="keyword">yield</span> fake_provider

    <span class="comment"># Tear Down</span>
    MessagesCollector.set(instance)</code></pre></div></div></div></div>
<div class="openblock right-column"><div class="content"><div class="listingblock"><div class="content"><pre class="CodeRay highlight"><code data-lang="python"><span class="keyword">def</span> <span class="function">test_print_messages</span>(message_provider):
    <span class="comment"># Given</span>
    fake_provider = message_provider
    out = io.StringIO
    report = ReportStream(out)

    fake_provider.messages = [Message(id=<span class="integer">1</span>, content=<span class="string"><span class="delimiter">'</span><span class="content">foo</span><span class="delimiter">'</span></span>)]


    <span class="comment"># When</span>
    report.report_last_messages()


    <span class="comment"># Then</span>
    <span class="keyword">assert</span> io.get_value() == <span class="string"><span class="delimiter">'</span><span class="content">ID:1 =&gt; foo</span><span class="delimiter">'</span></span></code></pre></div></div></div></div>
<div class="openblock reset-column center"><div class="content"><div class="paragraph"><p>C&#8217;est mieux, mais c&#8217;est perfectible &#8230;&#8203;</p></div></div></div></div></section><section id="_en_injectant_le_fournisseur"><h2>En injectant le fournisseur</h2><div class="slide-content"><div class="paragraph"><p>Passer du Singleton √† l&#8217;injection pour se d√©barrasser d√©finitivement</p></div>
<div class="openblock left-column"><div class="content"><div class="listingblock"><div class="content"><pre class="CodeRay highlight"><code data-lang="python"><span class="keyword">class</span> <span class="class">ReportStream</span>:

    <span class="keyword">def</span> <span class="function">__init__</span>(<span class="predefined-constant">self</span>, out: IO[<span class="predefined">str</span>])
        <span class="predefined-constant">self</span>.out = out

    <span class="keyword">def</span> <span class="function">report_last_messages</span>(<span class="predefined-constant">self</span>):
        messages = MessagesCollector.get_messages()
        <span class="keyword">if</span> <span class="keyword">not</span> messages:
            <span class="keyword">return</span>
        <span class="keyword">for</span> message <span class="keyword">in</span> messages:
            out.write(f<span class="string"><span class="delimiter">'</span><span class="content">ID:{message.id} =&gt; {message.content}</span><span class="delimiter">'</span></span>)</code></pre></div></div></div></div>
<div class="openblock right-column"><div class="content"><div class="listingblock"><div class="content"><pre class="CodeRay highlight"><code data-lang="python"><span class="keyword">class</span> <span class="class">ReportStream</span>:

    <span class="keyword">def</span> <span class="function">__init__</span>(<span class="predefined-constant">self</span>, out: IO[<span class="predefined">str</span>], provider: MessageProvider)
        <span class="predefined-constant">self</span>.out = out
        <span class="predefined-constant">self</span>.provider = provider

    <span class="keyword">def</span> <span class="function">report_last_messages</span>(<span class="predefined-constant">self</span>):
        messages = <span class="predefined-constant">self</span>.provider.get_messages()
        <span class="keyword">if</span> <span class="keyword">not</span> messages:
            <span class="keyword">return</span>
        <span class="keyword">for</span> message <span class="keyword">in</span> messages:
            out.write(f<span class="string"><span class="delimiter">'</span><span class="content">ID:{message.id} =&gt; {message.content}</span><span class="delimiter">'</span></span>)</code></pre></div></div></div></div></div></section><section id="_simplification_du_test"><h2>Simplification du test</h2><div class="slide-content"><div class="listingblock"><div class="content"><pre class="CodeRay highlight"><code data-lang="python"><span class="keyword">class</span> <span class="class">FakeMessageProvider</span>(MessageProvider):
    <span class="keyword">def</span> <span class="function">__init__</span>(<span class="predefined-constant">self</span>):
        <span class="predefined-constant">self</span>.messages = []

    <span class="keyword">def</span> <span class="function">get_messages</span>(<span class="predefined-constant">self</span>) -&gt; <span class="predefined">list</span>[Message]:
        <span class="keyword">return</span> <span class="predefined-constant">self</span>.messages

<span class="keyword">def</span> <span class="function">test_print_messages</span>():
    <span class="comment"># Given</span>
    fake_provider = FakeMessageProvider()
    out = io.StringIO
    report = ReportStream(out=out, provider=fake_provider)

    fake_provider.messages = [Message(id=<span class="integer">1</span>, content=<span class="string"><span class="delimiter">'</span><span class="content">foo</span><span class="delimiter">'</span></span>)]


    <span class="comment"># When</span>
    report.report_last_messages()


    <span class="comment"># Then</span>
    <span class="keyword">assert</span> io.get_value() == <span class="string"><span class="delimiter">'</span><span class="content">ID:1 =&gt; foo</span><span class="delimiter">'</span></span></code></pre></div></div>
<div class="openblock reset-column center fragment"><div class="content"><div class="paragraph"><p>Oui mais dans la vraie vie ? J&#8217;ai besoin d&#8217;une unique instance !!</p></div></div></div></div></section><section id="_singleton_uniquement_√†_linjection"><h2>Singleton, uniquement √† l&#8217;injection</h2><div class="slide-content"><div class="listingblock big"><div class="content"><pre class="CodeRay highlight"><code data-lang="python"><span class="line-numbers">1</span><span class="keyword">if</span> __name__ == <span class="string"><span class="delimiter">&quot;</span><span class="content">__main__</span><span class="delimiter">&quot;</span></span>:
<span class="line-numbers">2</span>    <span class="comment"># ------------------- Actual Singleton here -------------------</span>
<span class="line-numbers">3</span>    unique_message_provider = MessagesCollector.get()
<span class="line-numbers">4</span>    <span class="comment"># -------------------------------------------------------------</span>
<span class="line-numbers">5</span>
<span class="line-numbers">6</span>    report = ReportStream(out=out, provider=unique_message_provider)
<span class="line-numbers">7</span>    report.report_last_messages()</code></pre></div></div></div></section></section>
<section id="_r√©sum√©"><h2>R√©sum√©</h2><div class="slide-content"><div class="openblock center"><div class="content"><div class="paragraph"><p><strong>Avant</strong></p></div>
<div class="imageblock"><img src="../images/report_stream-0.svg" alt="report stream 0"></div></div></div></div></section>
<section id="_r√©sum√©_2"><h2>R√©sum√©</h2><div class="slide-content"><div class="openblock center"><div class="content"><div class="paragraph"><p><strong>Abstraction</strong></p></div>
<div class="imageblock"><img src="../images/report_stream-1.svg" alt="report stream 1"></div></div></div></div></section>
<section id="_r√©sum√©_3"><h2>R√©sum√©</h2><div class="slide-content"><div class="openblock center"><div class="content"><div class="paragraph"><p><strong>Injection</strong></p></div>
<div class="imageblock"><img src="../images/report_stream-2.svg" alt="report stream 2"></div></div></div></div></section>
<section id="_cas_dusage_simuler_une_base_de_donn√©es"><h2>Cas d&#8217;usage: Simuler une base de donn√©es</h2><div class="slide-content"><div class="ulist"><ul><li><p>Utiliser le pattern du repository</p><div class="ulist"><ul><li><p>Ins√©rer une couche d&#8217;abstraction si la construction des requ√™tes n&#8217;est pas de la responsabilit√© de l&#8217;objet sous test</p></li></ul></div></li></ul></div></div></section>
<section><section id="_exemple"><h2>Exemple</h2><div class="slide-content"><div class="ulist"><ul><li><p>Situation o√π nous d√©pendons d&#8217;une externatlit√©</p><div class="ulist"><ul><li><p>Base de donn√©es, API, librairie externe</p></li></ul></div></li></ul></div><div class="openblock reset-column"><div class="content"><div class="listingblock big"><div class="content"><pre class="CodeRay highlight"><code data-lang="python"><span class="keyword">import</span> <span class="include">expensive_to_test_api</span> <span class="keyword">as</span> api

<span class="keyword">class</span> <span class="class">CityService</span>:
    <span class="keyword">def</span> <span class="function">__init__</span>(<span class="predefined-constant">self</span>, store: api.Store):
        <span class="predefined-constant">self</span>.store = store

    <span class="keyword">def</span> <span class="function">get_cities_where_street_have_no_name</span>(<span class="predefined-constant">self</span>) -&gt; <span class="predefined">list</span>[City]:
        <span class="comment"># Lot of stuff with api</span>

     <span class="keyword">def</span> <span class="function">merge_cities</span>(<span class="predefined-constant">self</span>, city_name_left: <span class="predefined">str</span>, city_name_right: <span class="predefined">str</span>) -&gt; City:
        <span class="comment"># Lot of stuff with api</span>

    <span class="keyword">def</span> <span class="function">find_all_street_from_city</span>(<span class="predefined-constant">self</span>, city_name: <span class="predefined">str</span>) -&gt; <span class="predefined">list</span>[Street]:
        <span class="comment"># Lot of stuff with api</span>

    <span class="keyword">def</span> <span class="function">create_street_in_city</span>(<span class="predefined-constant">self</span>, street: Street, city: City) -&gt; Street:
        <span class="comment"># Lot of stuff with api</span></code></pre></div></div></div></div><div class="openblock left-column"><div class="content"><div class="listingblock"><div class="content"><pre class="CodeRay highlight"><code data-lang="python"><span class="decorator">@dataclass</span>
<span class="keyword">class</span> <span class="class">Street</span>:
    name: <span class="predefined">str</span>
    gps: GPS</code></pre></div></div></div></div><div class="openblock right-column"><div class="content"><div class="listingblock"><div class="content"><pre class="CodeRay highlight"><code data-lang="python"><span class="decorator">@dataclass</span>
<span class="keyword">class</span> <span class="class">City</span>:
    city_id: <span class="predefined">int</span>
    name: <span class="predefined">str</span>
    zip_code: ZipCode
    streets : <span class="predefined">list</span>[Street] = field(default_factory=<span class="predefined">list</span>)</code></pre></div></div></div></div></div></section><section id="_exemple_2"><div class="slide-content"><div class="listingblock big"><div class="content"><pre class="CodeRay highlight"><code data-lang="python"><span class="keyword">import</span> <span class="include">expensive_to_test_api</span> <span class="keyword">as</span> api

<span class="keyword">class</span> <span class="class">CityService</span>:
    <span class="keyword">def</span> <span class="function">__init__</span>(<span class="predefined-constant">self</span>, store: api.Store):
        <span class="predefined-constant">self</span>.store = store

    <span class="keyword">def</span> <span class="function">get_cities_where_street_have_no_name</span>(<span class="predefined-constant">self</span>) -&gt; <span class="predefined">list</span>[City]:
        <span class="keyword">try</span>:
            params = {}
            request = store.prepare_request(params)
            store_cursor = store.execute_request(request)
            cities = [<span class="predefined-constant">self</span>.convert_to_city(obj) <span class="keyword">for</span> obj <span class="keyword">in</span> store_cursor]
            <span class="keyword">return</span> cities
        <span class="keyword">except</span> StoreException <span class="keyword">as</span> se:
            <span class="keyword">raise</span> ModelException(se)</code></pre></div></div>
<div class="listingblock big"><div class="content"><pre class="CodeRay highlight"><code data-lang="python">    <span class="keyword">def</span> <span class="function">merge_cities</span>(<span class="predefined-constant">self</span>, city_name_left: <span class="predefined">str</span>, city_name_right: <span class="predefined">str</span>) -&gt; City:
        <span class="keyword">try</span>:
            _left = <span class="predefined-constant">self</span>.find_one_city_by_name(city_name_left)
            _right = <span class="predefined-constant">self</span>.find_one_city_by_name(city_name_right)
            <span class="comment"># ... a lot of operations</span>
            request = store.prepare_request(params)
            store_cursor = store.execute_request(request)
            city = <span class="predefined-constant">self</span>.convert_to_city(store_cursor.one())
            <span class="keyword">return</span> city
        <span class="keyword">except</span> StoreException <span class="keyword">as</span> se:
            <span class="keyword">raise</span> ModelException(se)</code></pre></div></div>
<div class="imageblock center"><img src="../images/testability-Repository_0.svg" alt="testability Repository 0"></div></div></section><section id="_exemple_3"><div class="slide-content"><div class="ulist"><ul><li><p>D√©pendance classique</p><div class="ulist"><ul><li><p>Base de donn√©es, API web externe, librairie tierce, &#8230;&#8203;</p></li><li><p>Lien tr√®s structurant &#8658; fort couplage &#8658; Difficult√© d&#8217;√©volutions</p></li></ul></div></li></ul></div>
<div class="imageblock center"><img src="../images/testability-Repository_1.svg" alt="testability Repository 1"></div>
<div class="ulist"><ul><li><p><code>expensive_to_test_api</code> compliqu√©e √† simuler.</p><div class="ulist"><ul><li><p>&#8658; A r√©server aux tests d&#8217;int√©grations</p></li><li><p>&#8658; Faible testabilit√© de <code>CityService</code></p></li></ul></div></li><li><p>Pistes</p><div class="ulist"><ul><li><p>Mocker, mais ce n&#8217;est pas l&#8217;objet du cours :)</p></li><li><p>D√©coupler avec de l&#8217;abstraction</p></li></ul></div></li></ul></div></div></section><section id="_pattern_repository"><h2>Pattern Repository</h2><div class="slide-content"><div class="ulist"><ul><li><p>Ajouter une couche d&#8217;abstraction</p><div class="ulist"><ul><li><p>Architecture en couche</p></li></ul></div></li><li><p>Pattern recommand√© &#8594; <code>Repository</code></p><div class="ulist"><ul><li><p><code>Repository</code> &#8658; abstraction de lecture/√©criture du domaine</p></li></ul></div></li></ul></div>
<div class="openblock left-column"><div class="content"><div class="paragraph center"><p><strong>Primitives</strong></p></div>
<div class="listingblock"><div class="content"><pre class="CodeRay highlight"><code data-lang="python"><span class="line-numbers"> 1</span><span class="keyword">class</span> <span class="class">TypeTRepository</span>:
<span class="line-numbers"> 2</span>    <span class="keyword">def</span> <span class="function">save</span>(<span class="predefined-constant">self</span>, t: T) -&gt; T :
<span class="line-numbers"> 3</span>        ...
<span class="line-numbers"> 4</span>    <span class="keyword">def</span> <span class="function">find_one</span>(<span class="predefined-constant">self</span>, <span class="predefined">id</span>: <span class="predefined">str</span>) -&gt; T :
<span class="line-numbers"> 5</span>        ...
<span class="line-numbers"> 6</span>    <span class="keyword">def</span> <span class="function">find_all</span>(<span class="predefined-constant">self</span>, ) -&gt; Sequence[T] :
<span class="line-numbers"> 7</span>        ...
<span class="line-numbers"> 8</span>    <span class="keyword">def</span> <span class="function">count</span>(<span class="predefined-constant">self</span>, ) -&gt; <span class="predefined">int</span> :
<span class="line-numbers"> 9</span>        ...
<span class="line-numbers">10</span>    <span class="keyword">def</span> <span class="function">delete</span>(<span class="predefined-constant">self</span>, t: T) :
<span class="line-numbers">11</span>        ...
<span class="line-numbers">12</span>    <span class="keyword">def</span> <span class="function">exists</span>(<span class="predefined-constant">self</span>, <span class="predefined">id</span>: <span class="predefined">str</span>) -&gt; <span class="predefined">bool</span> :
<span class="line-numbers">13</span>        ...</code></pre></div></div></div></div>
<div class="openblock right-column"><div class="content"><div class="paragraph center"><p><strong>Cas d&#8217;usage sp√©cifiques</strong></p></div>
<div class="listingblock"><div class="content"><pre class="CodeRay highlight"><code data-lang="python"><span class="line-numbers">1</span><span class="keyword">class</span> <span class="class">TypeTRepository</span>:
<span class="line-numbers">2</span>    <span class="comment"># ... usuals methods</span>
<span class="line-numbers">3</span>    <span class="keyword">def</span> <span class="function">find_all_by_name</span>(<span class="predefined-constant">self</span>, name: <span class="predefined">str</span>) -&gt; Sequence[T] :
<span class="line-numbers">4</span>        ...
<span class="line-numbers">5</span>    <span class="keyword">def</span> <span class="function">find_all_by_name_and_zip_are</span>(<span class="predefined-constant">self</span>, name: <span class="predefined">str</span>,
<span class="line-numbers">6</span>                                    area: <span class="predefined">str</span>) -&gt; Sequence[T] :
<span class="line-numbers">7</span>        ...</code></pre></div></div></div></div></div></section><section id="_pattern_repository_2"><h2>Pattern Repository</h2><div class="slide-content"><div class="paragraph"><p>D√©couplage entre <code>CityService</code> et <code>Expensive_to_test_api</code></p></div>
<div class="imageblock center"><img src="../images/testability-Repository_2.svg" alt="testability Repository 2"></div>
<div class="paragraph"><p>Possibilit√© d&#8217;extension</p></div>
<div class="imageblock center"><img src="../images/testability-Repository_3.svg" alt="testability Repository 3"></div>
<aside class="notes"><div class="paragraph"><p>Voir, au sujet du repository, les articles suivants</p></div>
<div class="ulist"><ul><li><p><a href="https://www.cosmicpython.com/book/chapter_02_repository.html" class="bare">https://www.cosmicpython.com/book/chapter_02_repository.html</a></p></li><li><p><a href="https://martinfowler.com/eaaCatalog/repository.html" class="bare">https://martinfowler.com/eaaCatalog/repository.html</a></p></li></ul></div></aside></div></section></section>
<section id="_exemple_4"><h2>Exemple</h2><div class="slide-content"><div class="paragraph"><p>Cr√©ation de classes adapt√©es</p></div>
<div class="imageblock center"><img src="../images/testability-Repository_4.svg" alt="testability Repository 4"></div></div></section>
<section><section id="_exemple_5"><h2>Exemple</h2><div class="slide-content"><div class="listingblock"><div class="content"><pre class="CodeRay highlight"><code data-lang="python"><span class="line-numbers">1</span><span class="keyword">class</span> <span class="class">CityRepository</span>(Protocol):
<span class="line-numbers">2</span>    <span class="keyword">def</span> <span class="function">find</span>(<span class="predefined-constant">self</span>, city_id: <span class="predefined">int</span>) -&gt; City: ...
<span class="line-numbers">3</span>    <span class="keyword">def</span> <span class="function">find_by_name</span>(<span class="predefined-constant">self</span>, city_id: <span class="predefined">int</span>) -&gt; City: ...
<span class="line-numbers">4</span>    <span class="keyword">def</span> <span class="function">find_all</span>(<span class="predefined-constant">self</span>) -&gt; <span class="predefined">list</span>[City]: ...
<span class="line-numbers">5</span>    <span class="keyword">def</span> <span class="function">find_all_where_street_have_no_name</span>(<span class="predefined-constant">self</span>, criteria: Dict) -&gt; <span class="predefined">list</span>[City]: ...
<span class="line-numbers">6</span>    <span class="keyword">def</span> <span class="function">save</span>(<span class="predefined-constant">self</span>, city: City) -&gt; City]: ...</code></pre></div></div><div class="listingblock"><div class="content"><pre class="CodeRay highlight"><code data-lang="python"><span class="line-numbers"> 1</span><span class="keyword">class</span> <span class="class">CityService</span>:
<span class="line-numbers"> 2</span>    <span class="keyword">def</span> <span class="function">__init__</span>(<span class="predefined-constant">self</span>, repository: CityRepository):
<span class="line-numbers"> 3</span>        <span class="predefined-constant">self</span>.repository = repository
<span class="line-numbers"> 4</span>
<span class="line-numbers"> 5</span>    <span class="keyword">def</span> <span class="function">get_cities_where_street_have_no_name</span>(<span class="predefined-constant">self</span>) -&gt; <span class="predefined">list</span>[City]:
<span class="line-numbers"> 6</span>        <span class="keyword">return</span> <span class="predefined-constant">self</span>.repository.find_all_where_street_have_no_name()
<span class="line-numbers"> 7</span>
<span class="line-numbers"> 8</span>    <span class="keyword">def</span> <span class="function">merge_cities</span>(<span class="predefined-constant">self</span>, city_name_left: <span class="predefined">str</span>, city_name_right: <span class="predefined">str</span>) -&gt; City:
<span class="line-numbers"> 9</span>        _left = <span class="predefined-constant">self</span>.repository.find_by_name(city_name_left)
<span class="line-numbers">10</span>        _right = <span class="predefined-constant">self</span>.repository.find_by_name(city_name_right)
<span class="line-numbers">11</span>        <span class="comment"># ... a lot of operations</span>
<span class="line-numbers">12</span>        merged_city = <span class="predefined-constant">self</span>.repository.save(merge_city)
<span class="line-numbers">13</span>        <span class="keyword">return</span> merged_city</code></pre></div></div></div></section><section id="_testing_avec_repository"><h2>Testing avec repository</h2><div class="slide-content"><div class="openblock"><div class="content"><div class="listingblock"><div class="content"><pre class="CodeRay highlight"><code data-lang="python"><span class="line-numbers"> 1</span><span class="keyword">def</span> <span class="function">test_city_service_merge_cities</span>():
<span class="line-numbers"> 2</span>    <span class="comment"># Given</span>
<span class="line-numbers"> 3</span>    NB_CITY=<span class="integer">2</span>
<span class="line-numbers"> 4</span>    left  = City(city_id=<span class="integer">0</span>, name=<span class="string"><span class="delimiter">&quot;</span><span class="content">Left</span><span class="delimiter">&quot;</span></span>,  zip_code=ZipCode(<span class="integer">91200</span>), streets=[Street(f<span class="string"><span class="delimiter">&quot;</span><span class="content">name_left_{i}</span><span class="delimiter">&quot;</span></span>,<span class="predefined-constant">None</span>) <span class="keyword">for</span> i <span class="keyword">in</span> <span class="predefined">range</span>(NB_CITY)])
<span class="line-numbers"> 5</span>    right = City(city_id=<span class="integer">1</span>, name=<span class="string"><span class="delimiter">&quot;</span><span class="content">Right</span><span class="delimiter">&quot;</span></span>, zip_code=ZipCode(<span class="integer">91201</span>), streets=[Street(f<span class="string"><span class="delimiter">&quot;</span><span class="content">name_right_{i}</span><span class="delimiter">&quot;</span></span>,<span class="predefined-constant">None</span>) <span class="keyword">for</span> i <span class="keyword">in</span> <span class="predefined">range</span>(NB_CITY)])
<span class="line-numbers"> 6</span>
<span class="line-numbers"> 7</span>    <span class="keyword">class</span> <span class="class">FakeCityRepository</span>:
<span class="line-numbers"> 8</span>        <span class="keyword">def</span> <span class="function">find_by_name</span>(<span class="predefined-constant">self</span>, name: <span class="predefined">str</span>):
<span class="line-numbers"> 9</span>            <span class="keyword">return</span> left <span class="keyword">if</span> name = <span class="string"><span class="delimiter">&quot;</span><span class="content">Left</span><span class="delimiter">&quot;</span></span> <span class="keyword">else</span> right   <span class="comment"># &lt;-- no big deal. Easy and rapid to simulate</span>
<span class="line-numbers">10</span>
<span class="line-numbers">11</span>        <span class="keyword">def</span> <span class="function">save</span>(<span class="predefined-constant">self</span>, city):
<span class="line-numbers">12</span>            <span class="keyword">return</span> city                               <span class="comment"># &lt;-- no big deal. Easy and rapid to simulate</span>
<span class="line-numbers">13</span>
<span class="line-numbers">14</span>    fake_city_repository = FakeCityRepository()
<span class="line-numbers">15</span>    service = CityService(repository=fake_city_repository)</code></pre></div></div></div></div>
<div class="listingblock"><div class="content"><pre class="CodeRay highlight"><code data-lang="python">    <span class="comment"># When</span>
    merged_city = service.merge(left, right)

    <span class="comment"># Then</span>
    <span class="keyword">assert</span> merged_city.name = <span class="string"><span class="delimiter">&quot;</span><span class="content">Left-Right</span><span class="delimiter">&quot;</span></span>
    <span class="keyword">assert</span> {name <span class="keyword">for</span> street.name <span class="keyword">in</span> merged.streets} = {<span class="string"><span class="delimiter">'</span><span class="content">name_left_0</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">name_left_1</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">name_right_0</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">name_right_1</span><span class="delimiter">'</span></span>}</code></pre></div></div></div></section></section>
<section id="_fail_fast"><h2>Fail Fast</h2><div class="slide-content"><div class="ulist"><ul><li><p>S&#8217;abstraire d&#8217;une externalit√©</p><div class="ulist"><ul><li><p>&#8658; Monter des d√©monstrateurs <em>fail fast</em></p><div class="ulist"><ul><li><p>Valider rapide d&#8217;une hypoth√®se avec le <em>client</em></p></li></ul></div></li></ul></div></li></ul></div>
<div class="quoteblock"><blockquote><div class="paragraph"><p><em>Recherche de cycles courts et de feedback client</em></p></div></blockquote></div>
<div class="imageblock center"><img src="../images/testability-fail-fast.svg" alt="testability fail fast"></div></div></section>
<section><section id="_obstacle_boucles_imbriqu√©es"><h2>Obstacle &gt; boucles imbriqu√©es</h2><div class="slide-content"><div class="ulist"><ul><li><p>Priorit√© Single Responsability Principle</p><div class="ulist"><ul><li><p>Boucles imbriqu√©es avec plusieurs responsabilit√©s m√©lang√©es</p></li></ul></div></li></ul></div><div class="listingblock big"><div class="content"><pre class="CodeRay highlight"><code data-lang="python">avg_w_lug = <span class="integer">0</span>
total_p = <span class="integer">0</span>

<span class="keyword">for</span> r <span class="keyword">in</span> flight.reservations:
    <span class="keyword">for</span> lug <span class="keyword">in</span> r.luggages:
        avg_w_lug += lug.weight <span class="keyword">if</span> <span class="keyword">not</span> lug.cabin <span class="keyword">or</span> <span class="integer">0</span>
    p = r.price
    <span class="keyword">if</span> r.discnt:
        p = p * r.discnt
    total_p += p

avg_w_lug = avg_w_lug / <span class="predefined">len</span>(reservations)</code></pre></div></div><div class="paragraph fragment"><p>Ah oui, encore une version compress√©e&#8230;&#8203;</p></div></div></section><section id="_obstacle_boucles_imbriqu√©es_2"><h2>Obstacle &gt; boucles imbriqu√©es</h2><div class="slide-content"><div class="paragraph"><p>En clair</p></div>
<div class="listingblock big"><div class="content"><pre class="CodeRay highlight"><code data-lang="python">average_weight_luggage = <span class="integer">0</span>
total_price = <span class="integer">0</span>

<span class="keyword">for</span> reservation <span class="keyword">in</span> flight.reservations:
    <span class="keyword">for</span> luggage <span class="keyword">in</span> reservation.luggages:
        average_weight_luggage += luggage.weight <span class="keyword">if</span> <span class="keyword">not</span> luggage.in_cabin <span class="keyword">or</span> <span class="integer">0</span>

    price = reservation.price
    <span class="keyword">if</span> reservation.discount:
        price = price * reservation.discount
    total_price += price

average_weight_luggage = average_weight_luggage / <span class="predefined">len</span>(reservations)</code></pre></div></div>
<div class="ulist"><ul><li><p>Comment tester et surtout quoi tester ?</p><div class="ulist"><ul><li><p>Responsabilit√©s m√©lang√©es ?</p><div class="ulist"><ul><li><p>Lesquelles ?</p></li></ul></div></li></ul></div></li></ul></div></div></section><section id="_obstacle_boucles_imbriqu√©es_3"><h2>Obstacle &gt; boucles imbriqu√©es</h2><div class="slide-content"><div class="ulist"><ul><li><p>Responsabilit√©s identifi√©es</p><div class="ulist"><ul><li><p><em>Calcul du poids total des baggages en soute</em></p></li><li><p><em>Calcul du prix total du vol</em></p></li></ul></div></li></ul></div>
<div class="paragraph"><p>R√©√©criture</p></div>
<div class="listingblock big"><div class="content"><pre class="CodeRay highlight"><code data-lang="python">average_weight_luggage = <span class="integer">0</span>
<span class="keyword">for</span> reservation <span class="keyword">in</span> flight.reservations:
    <span class="keyword">for</span> luggage <span class="keyword">in</span> reservation.luggages:
        average_weight_luggage += luggage.weight <span class="keyword">if</span> <span class="keyword">not</span> luggage.in_cabin <span class="keyword">or</span> <span class="integer">0</span>
average_weight_luggage = average_weight_luggage / <span class="predefined">len</span>(reservations)

total_price = <span class="integer">0</span>
<span class="keyword">for</span> reservation <span class="keyword">in</span> flight.reservations:
    price = reservation.price
    <span class="keyword">if</span> reservation.discount:
        price = price * reservation.discount
    total_price += price</code></pre></div></div>
<div class="listingblock"><div class="content"><pre class="CodeRay highlight"><code data-lang="python"><span class="keyword">def</span> <span class="function">test_total_weight_with_some_cabin_bagages_and_without_discount</span>():
    ...
<span class="keyword">def</span> <span class="function">test_total_price_with_discounts_but_no_baggages</span>():
    ...</code></pre></div></div></div></section><section id="_obstacle_boucles_imbriqu√©es_4"><h2>Obstacle &gt; boucles imbriqu√©es</h2><div class="slide-content"><div class="paragraph"><p>R√©√©criture</p></div>
<div class="listingblock big"><div class="content"><pre class="CodeRay highlight"><code data-lang="python"><span class="keyword">def</span> <span class="function">get_total_weight_of_in_hold_baggages</span>(reservations: List[Reservation]) -&gt; <span class="predefined">float</span>:
    average_weight = <span class="integer">0</span>
    <span class="keyword">for</span> reservation <span class="keyword">in</span> reservations:
        <span class="keyword">for</span> luggage <span class="keyword">in</span> reservation.luggages:
            average_weight += luggage.weight <span class="keyword">if</span> <span class="keyword">not</span> luggage.in_cabin <span class="keyword">or</span> <span class="integer">0</span>
    average_weight = average_weight / <span class="predefined">len</span>(reservations)
    <span class="keyword">return</span> average_weight

<span class="keyword">def</span> <span class="function">get_total_price</span>(reservations: List[Reservation]) -&gt; <span class="predefined">float</span>:
    total = <span class="integer">0</span>
    <span class="keyword">for</span> reservation <span class="keyword">in</span> reservations:
        price = reservation.price
        <span class="keyword">if</span> reservation.discount:
            price = price * reservation.discount
        total += price
    <span class="keyword">return</span> total</code></pre></div></div>
<div class="listingblock big"><div class="content"><pre class="CodeRay highlight"><code data-lang="python"><span class="keyword">def</span> <span class="function">test_total_weight_with_some_cabin_bagages</span>(): ...
<span class="keyword">def</span> <span class="function">test_total_weight_without_bagages</span>(): ...
<span class="keyword">def</span> <span class="function">test_total_price_with_some_discounts</span>():  ...
<span class="keyword">def</span> <span class="function">test_total_price_without_discounts</span>(): ...</code></pre></div></div></div></section></section>
<section id="_design_vs_performance"><h2>Design vs performance</h2><div class="slide-content"><div class="ulist"><ul><li><p>Un faux d√©bat</p><div class="ulist"><ul><li><p>&#8658; Souvent la d√©gradation est minime</p></li><li><p>&#8658; Les compilateurs sont capables d&#8217;optimiser</p><div class="ulist"><ul><li><p>Python&#8230;&#8203;un peu <a href="https://wiki.python.org/moin/PythonSpeed/PerformanceTips" class="bare">https://wiki.python.org/moin/PythonSpeed/PerformanceTips</a></p></li></ul></div></li><li><p>Seul un profiling est pertinent</p></li></ul></div></li><li><p>Ce qui compte</p><div class="ulist"><ul><li><p>(1) Bien √©crire le code.</p></li><li><p>(2) V√©rifier qu&#8217;il est correct (passe les tests)</p></li><li><p>(3) √âtablir un profil en cas de lenteur seulement.</p></li><li><p>(4) Optimiser si besoin.</p></li><li><p>(5) R√©p√©ter √† partir du point 2.</p></li></ul></div></li></ul></div></div></section>
<section id="_am√©lioration_de_la_testabilit√©_par_la_hi√©rarchisation"><h2>Am√©lioration de la testabilit√© par la hi√©rarchisation</h2></section>
<section id="_testing_par_surcharge"><h2>Testing par surcharge</h2><div class="slide-content"><div class="ulist simple"><ul><li><p>Nouvelles r√®gles pour <code>RadioCommunicator</code></p><div class="ulist"><ul><li><p>Evolution de  <code>Channel</code> &#8658; √©volution de <code>RadioCommunicator</code></p></li></ul></div></li></ul></div>
<div class="exampleblock smaller center"><div class="content"><div class="paragraph"><p><strong>SI</strong> <code>Channel</code> <em>ouvert</em> <strong>ET</strong> <em>√©crivable</em>
<strong>ALORS</strong> <em>envoyer un message</em><br>
<strong>SINON</strong> mettre message <em>en liste d&#8217;attente</em>.</p></div></div></div>
<div class="paragraph center"><p><strong>Alerte : responsabilit√©s !!</strong></p></div></div></section>
<section id="_testing_par_surcharge_2"><h2>Testing par surcharge</h2><div class="slide-content"><div class="listingblock big"><div class="content"><pre class="CodeRay highlight"><code data-lang="python"><span class="line-numbers"> 1</span><span class="keyword">class</span> <span class="class">RadioCommunicator</span>(Communicator):
<span class="line-numbers"> 2</span>
<span class="line-numbers"> 3</span>    <span class="keyword">def</span> <span class="function">__init__</span>(<span class="predefined-constant">self</span>, transmitter: RadioTransmitter):
<span class="line-numbers"> 4</span>        <span class="predefined-constant">self</span>.transmitter: RadioTransmitter = transmitter
<span class="line-numbers"> 5</span>
<span class="line-numbers"> 6</span>    <span class="keyword">def</span> <span class="function">send</span>(msg: Message) -&gt; <span class="predefined-constant">None</span>:
<span class="line-numbers"> 7</span>        <span class="keyword">if</span> <span class="keyword">not</span> <span class="predefined-constant">self</span>.check_compliance_with_very_complicated_rules(msg):
<span class="line-numbers"> 8</span>            <span class="keyword">return</span>
<span class="line-numbers"> 9</span>        <span class="comment">#----*--*----*--*----*--*----*--*----*--*----*--*----*--*----</span>
<span class="line-numbers">10</span>        channel: Channel = <span class="predefined-constant">self</span>.transmitter.get_channel()
<span class="line-numbers">11</span>        <span class="keyword">if</span> channel.is_open() <span class="keyword">and</span> channel.is_writable():     <span class="comment"># &lt;--- New rule !</span>
<span class="line-numbers">12</span>            channel.write(Message.to_base68(msg))
<span class="line-numbers">13</span>            channel.close()
<span class="line-numbers">14</span>        <span class="keyword">else</span>:
<span class="line-numbers">15</span>            <span class="predefined-constant">self</span>.pending_messages.append(msg)
<span class="line-numbers">16</span>        <span class="comment">#----*--*----*--*----*--*----*--*----*--*----*--*----*--*----</span></code></pre></div></div></div></section>
<section id="_testing_par_surcharge_3"><h2>Testing par surcharge</h2><div class="slide-content"><div class="paragraph"><p>Une classe a une m√©thode tr√®s difficile √† tester car elle a des d√©pendances irritantes</p></div>
<div class="imageblock center"><img src="../images/testability-hierarchy-slide-test_0.svg" alt="testability hierarchy slide test 0"></div></div></section>
<section id="_testing_par_surcharge_4"><h2>Testing par surcharge</h2><div class="slide-content"><div class="paragraph"><p><strong>(1)</strong> Isoler, dans la m√©thode, les √©l√©ments irritants</p></div>
<div class="imageblock center"><img src="../images/testability-hierarchy-slide-test_1.svg" alt="testability hierarchy slide test 1"></div></div></section>
<section id="_testing_par_surcharge_5"><h2>Testing par surcharge</h2><div class="slide-content"><div class="paragraph"><p><strong>(2)</strong> Extraire les √©l√©ments irritants dans une m√©thode d√©di√©e <code>very_hard(&#8230;&#8203;)</code></p></div>
<div class="imageblock center"><img src="../images/testability-hierarchy-slide-test_2.svg" alt="testability hierarchy slide test 2"></div></div></section>
<section id="_testing_par_surcharge_6"><h2>Testing par surcharge</h2><div class="slide-content"><div class="paragraph"><p><strong>(3.a)</strong> D√©river (faire h√©riter) une classe de test<br>
<strong>(3.b)</strong> Rendre inoffensive la m√©thode <code>very_hard(&#8230;&#8203;)</code> en la <strong>surchargeant</strong><br>
<strong>(3.c)</strong> Simuler son comportement √† fin de tester le <strong>reste</strong> de la classe</p></div>
<div class="imageblock center"><img src="../images/testability-hierarchy-slide-test_3.svg" alt="testability hierarchy slide test 3"></div></div></section>
<section><div class="slide-content"><div class="ulist"><ul><li><p>√âtape 1</p><div class="ulist"><ul><li><p><code>Extract Method</code></p><div class="ulist"><ul><li><p><code>_write_to_channel(Message)</code></p></li></ul></div></li></ul></div></li></ul></div>
<div class="listingblock"><div class="content"><pre class="CodeRay highlight"><code data-lang="python"><span class="keyword">class</span> <span class="class">RadioCommunicator</span>(Communicator):

    <span class="comment">#...</span>

    <span class="keyword">def</span> <span class="function">send</span>(msg: Message) -&gt; <span class="predefined-constant">None</span>:
        <span class="keyword">if</span> <span class="keyword">not</span> <span class="predefined-constant">self</span>.check_compliance_with_very_complicated_rules(msg):
            <span class="keyword">return</span>

        <span class="keyword">if</span> <span class="keyword">not</span> <span class="predefined-constant">self</span>._write_to_channel(msg)
            <span class="predefined-constant">self</span>.pending_messages.append(msg)

    <span class="comment">#----*--*----*--*----*--*----*--*----*--*----*--*----*--*----</span>
    <span class="keyword">def</span> <span class="function">_write_to_channel</span>(<span class="predefined-constant">self</span>, mgs: Message):
        channel: Channel = <span class="predefined-constant">self</span>.transmitter.get_channel()
        <span class="keyword">if</span> channel.is_open() <span class="keyword">and</span> channel.is_writable():
            channel.write(Message.to_base68(msg))
            channel.close()
            <span class="keyword">return</span> <span class="predefined-constant">True</span>
        <span class="keyword">return</span> <span class="predefined-constant">False</span>
    <span class="comment">#----*--*----*--*----*--*----*--*----*--*----*--*----*--*----</span></code></pre></div></div></div></section>
<section><div class="slide-content"><div class="ulist"><ul><li><p>√âtape 2</p><div class="ulist"><ul><li><p>Cr√©ation classe de test en <strong>h√©ritant</strong> de la classe √† tester</p></li><li><p>Surcharge de  <code>_write_to_channel</code> pour la rendre inoffensive</p><div class="ulist"><ul><li><p>&#8656; <strong>probl√©matique</strong>, <strong>hors responsabilit√©</strong></p></li></ul></div></li></ul></div></li></ul></div>
<div class="listingblock"><div class="content"><pre class="CodeRay highlight"><code data-lang="python"><span class="line-numbers"> 1</span><span class="keyword">class</span> <span class="class">ForTestRadioCommunicator</span>(RadioCommunicator):
<span class="line-numbers"> 2</span>
<span class="line-numbers"> 3</span>    <span class="keyword">def</span> <span class="function">__init__</span>(<span class="predefined-constant">self</span>, channel_is_open: <span class="predefined">bool</span>, channel_is_writable: <span class="predefined">bool</span>):
<span class="line-numbers"> 4</span>        <span class="predefined">super</span>().__init__(<span class="predefined-constant">None</span>, <span class="predefined-constant">None</span>)
<span class="line-numbers"> 5</span>        <span class="predefined-constant">self</span>.channel_is_open = channel_is_open
<span class="line-numbers"> 6</span>        <span class="predefined-constant">self</span>.channel_is_writable = channel_is_writable
<span class="line-numbers"> 7</span>
<span class="line-numbers"> 8</span>    <span class="comment">#----*--*----*--*----*--*----*--*----*--*----*--*----*--*----</span>
<span class="line-numbers"> 9</span>    <span class="keyword">def</span> <span class="function">_write_to_channel</span>(<span class="predefined-constant">self</span>, mgs: Message):
<span class="line-numbers">10</span>        <span class="keyword">return</span> <span class="predefined-constant">self</span>.channel_is_open <span class="keyword">and</span> <span class="predefined-constant">self</span>.channel_is_writable
<span class="line-numbers">11</span>    <span class="comment">#----*--*----*--*----*--*----*--*----*--*----*--*----*--*----</span></code></pre></div></div>
<aside class="notes"><div class="paragraph"><p>Nous surchargeons la m√©thode probl√©matique <code>_write_to_channel</code> car elle est difficile √† simuler et surtout elle est hors responsabilit√©.</p></div>
<div class="paragraph"><p>Ce probl√®me rel√®ve de l&#8217;expertise tr√®s sp√©cifique <code>Transmission par canaux</code>, pas <code>Communication g√©n√©rale des message</code></p></div></aside>
<div class="listingblock"><div class="content"><pre class="CodeRay highlight"><code data-lang="python"><span class="keyword">def</span> <span class="function">test_send_message</span>():
    <span class="comment"># Given</span>
    communicator = ForTestRadioCommunicator(transmitter=fake_transmitter)
    message = Message(id=<span class="integer">123</span>, content=f<span class="string"><span class="delimiter">'</span><span class="content">CONTACT server=nowhere.com</span><span class="delimiter">'</span></span>)

    <span class="comment"># When</span>
    communicator.send(message)

    <span class="comment"># Then</span>
    <span class="keyword">assert</span> message <span class="keyword">in</span> communicator.pending_messages</code></pre></div></div></div></section>
<section id="_test_par_sous_classage"><h2>Test par sous-classage</h2><div class="slide-content"><div class="paragraph"><p>Autre possibilit√©:
<strong>(1)</strong> Extraire une classe abstraite, moins sp√©cialis√©e<br>
<strong>(2)</strong> Rendre la m√©thode <code>very_hard(&#8230;&#8203;)</code> <em>abstraite</em> (√† cr√©er)</p></div>
<div class="imageblock center"><img src="../images/testability-hierarchy-slide-test_4.svg" alt="testability hierarchy slide test 4"></div></div></section>
<section><section id="_test_par_sous_classage_2"><h2>Test par sous-classage</h2><div class="slide-content"><div class="paragraph"><p><strong>(3.a)</strong> D√©river (faire h√©riter) une classe de test <em>de la classe abstraite</em><br>
<strong>(3.b)</strong> Rendre inoffensive la m√©thode <code>very_hard(&#8230;&#8203;)</code><br>
<strong>(3.c)</strong> Simuler son comportement √† fin de tester le <strong>reste</strong> de la classe</p></div><div class="imageblock center"><img src="../images/testability-hierarchy-slide-test_5.svg" alt="testability hierarchy slide test 5"></div></div></section><section id="_test_par_sous_classage_3"><h2>Test par sous-classage</h2><div class="slide-content"><div class="listingblock"><div class="content"><pre class="CodeRay highlight"><code data-lang="python"><span class="keyword">class</span> <span class="class">GitlabIssueDispatcher</span>:

    <span class="keyword">def</span> <span class="function">__init__</span>(<span class="predefined-constant">self</span>, gitlab: Gitlab):
        <span class="predefined-constant">self</span>.gitlab = gitlab

    <span class="keyword">def</span> <span class="function">dispatch</span>(<span class="predefined-constant">self</span>, issues: List[Issue]):
        <span class="predefined-constant">self</span>.deduplicate_issues(issues)
        <span class="predefined-constant">self</span>.balance_issues_per_assignee(issues)
        <span class="predefined-constant">self</span>.create_issues_in_tracking_system(issues)

    <span class="keyword">def</span> <span class="function">deduplicate_issues</span>(<span class="predefined-constant">self</span>, issues: List[Issue]) -&gt; <span class="predefined-constant">None</span>:
        <span class="comment"># Do something</span>
    <span class="keyword">def</span> <span class="function">balance_issues_per_assignee</span>(<span class="predefined-constant">self</span>, issues: List[Issue]) -&gt; <span class="predefined-constant">None</span>:
        <span class="comment"># Do something</span>

    <span class="comment">#----*--*----*--*----*--*----*--*----*--*----*--*----*--*----</span>
    <span class="keyword">def</span> <span class="function">convert_to_tracking_system</span>(<span class="predefined-constant">self</span>, issue: Issue) -&gt; Any:
        <span class="comment"># Do something</span>

    <span class="keyword">def</span> <span class="function">create_issues_in_tracking_system</span>(<span class="predefined-constant">self</span>, issues : List[Issue]) -&gt; <span class="predefined-constant">None</span>:
        <span class="keyword">for</span> issue <span class="keyword">in</span> <span class="predefined-constant">self</span>.issues:
            project_id = issue.project_id
            project = <span class="predefined-constant">self</span>.gitlab.projects.get(id=project_id)
            project.issues.create(<span class="predefined-constant">self</span>.convert_to_tracking_system(issue))
    <span class="comment">#----*--*----*--*----*--*----*--*----*--*----*--*----*--*----</span></code></pre></div></div>
<div class="paragraph"><p>Nous voulons tester l&#8217;encha√Ænement des √©tapes.
Le test serait plus facile √† faire si on se d√©barrassait de la d√©pendance √† la librairie <code>python-gitlab</code> non ?</p></div>
<div class="ulist"><ul><li><p>√âtapes</p><div class="ulist"><ul><li><p><code>Extract class</code> <code>GitlabIssueDispatcher</code> &#8594; <code>IssueDispatcher</code></p></li><li><p>Laisser la m√©thode ou les m√©thodes  probl√©matiques non d√©finies et abstraites</p></li></ul></div></li></ul></div>
<div class="listingblock"><div class="content"><pre class="CodeRay highlight"><code data-lang="python"><span class="keyword">class</span> <span class="class">IssueDispatcher</span>(ABC):

    <span class="keyword">def</span> <span class="function">__init__</span>(<span class="predefined-constant">self</span>):

    <span class="keyword">def</span> <span class="function">dispatch</span>(<span class="predefined-constant">self</span>, issues: List[Issue]):
        <span class="predefined-constant">self</span>.deduplicate_issues(issues)
        <span class="predefined-constant">self</span>.balance_issues_per_assignee(issues)
        <span class="predefined-constant">self</span>.create_issues_in_tracking_system(issues)

    <span class="keyword">def</span> <span class="function">deduplicate_issues</span>(<span class="predefined-constant">self</span>, issues: List[Issue]) -&gt; <span class="predefined-constant">None</span>:
        <span class="comment"># Do something</span>
    <span class="keyword">def</span> <span class="function">balance_issues_per_assignee</span>(<span class="predefined-constant">self</span>, issues: List[Issue]) -&gt; <span class="predefined-constant">None</span>:
        <span class="comment"># Do something</span>

    <span class="comment">#----*--*----*--*----*--*----*--*----*--*----*--*----*--*----</span>
    <span class="decorator">@abstractmethod</span>
    <span class="keyword">def</span> <span class="function">convert_to_tracking_system</span>(<span class="predefined-constant">self</span>, issue: Issue) -&gt; Any:
        <span class="keyword">pass</span>

    <span class="decorator">@abstractmethod</span>
    <span class="keyword">def</span> <span class="function">create_issues_in_tracking_system</span>(<span class="predefined-constant">self</span>, issues : List[Issue]) -&gt; <span class="predefined-constant">None</span>:
        <span class="keyword">pass</span>
    <span class="comment">#----*--*----*--*----*--*----*--*----*--*----*--*----*--*----</span></code></pre></div></div>
<div class="listingblock"><div class="content"><pre class="CodeRay highlight"><code data-lang="python"><span class="line-numbers"> 1</span><span class="keyword">class</span> <span class="class">GitlabIssueDispatcher</span>(IssueDispatcher):
<span class="line-numbers"> 2</span>
<span class="line-numbers"> 3</span>    <span class="keyword">def</span> <span class="function">__init__</span>(<span class="predefined-constant">self</span>, file_path: Path, gitlab: Gitlab):
<span class="line-numbers"> 4</span>        <span class="predefined">super</span>().__init__(file_path)
<span class="line-numbers"> 5</span>        <span class="predefined-constant">self</span>.gitlab = gitlab
<span class="line-numbers"> 6</span>
<span class="line-numbers"> 7</span>    <span class="comment">#----*--*----*--*----*--*----*--*----*--*----*--*----*--*----</span>
<span class="line-numbers"> 8</span>    <span class="keyword">def</span> <span class="function">convert_to_tracking_system</span>(<span class="predefined-constant">self</span>, issue: Issue) -&gt; Any:
<span class="line-numbers"> 9</span>        <span class="comment"># Do something</span>
<span class="line-numbers">10</span>
<span class="line-numbers">11</span>    <span class="keyword">def</span> <span class="function">create_issues_in_tracking_system</span>(<span class="predefined-constant">self</span>, issues : List[Issue]) -&gt; <span class="predefined-constant">None</span>:
<span class="line-numbers">12</span>        <span class="keyword">for</span> issue <span class="keyword">in</span> <span class="predefined-constant">self</span>.issues:
<span class="line-numbers">13</span>            project_id = issue.project_id
<span class="line-numbers">14</span>            project = <span class="predefined-constant">self</span>.gitlab.projects.get(id=project_id)
<span class="line-numbers">15</span>            project.issues.create(<span class="predefined-constant">self</span>.convert_to_tracking_system(issue))
<span class="line-numbers">16</span>    <span class="comment">#----*--*----*--*----*--*----*--*----*--*----*--*----*--*----</span></code></pre></div></div>
<div class="listingblock"><div class="content"><pre class="CodeRay highlight"><code data-lang="python"><span class="line-numbers"> 1</span><span class="keyword">class</span> <span class="class">ForTestIssueDispatcher</span>(IssueDispatcher):
<span class="line-numbers"> 2</span>    <span class="keyword">def</span> <span class="function">__init__</span>(<span class="predefined-constant">self</span>, file_path):
<span class="line-numbers"> 3</span>        <span class="predefined">super</span>().__init__(file_path)
<span class="line-numbers"> 4</span>
<span class="line-numbers"> 5</span>    <span class="comment">#----*--*----*--*----*--*----*--*----*--*----*--*----*--*----</span>
<span class="line-numbers"> 6</span>    <span class="keyword">def</span> <span class="function">convert_to_tracking_system</span>(<span class="predefined-constant">self</span>, issue: Issue) -&gt; Any:
<span class="line-numbers"> 7</span>        <span class="comment"># Don't care</span>
<span class="line-numbers"> 8</span>        <span class="keyword">pass</span>
<span class="line-numbers"> 9</span>
<span class="line-numbers">10</span>    <span class="keyword">def</span> <span class="function">create_issues_in_tracking_system</span>(<span class="predefined-constant">self</span>, issues : List[Issue]) -&gt; <span class="predefined-constant">None</span>:
<span class="line-numbers">11</span>        <span class="comment"># Don't care</span>
<span class="line-numbers">12</span>        <span class="keyword">pass</span>
<span class="line-numbers">13</span>    <span class="comment">#----*--*----*--*----*--*----*--*----*--*----*--*----*--*----</span></code></pre></div></div>
<div class="listingblock"><div class="content"><pre class="CodeRay highlight"><code data-lang="python"><span class="line-numbers"> 1</span><span class="keyword">def</span> <span class="function">test_issue_dispatcher</span>()
<span class="line-numbers"> 2</span>    <span class="comment"># Given</span>
<span class="line-numbers"> 3</span>    dispatcher = ForTestIssueDispatcher()
<span class="line-numbers"> 4</span>    issues = [Issue(id=i, assignee=j) <span class="keyword">for</span> i <span class="keyword">in</span> <span class="predefined">range</span>(<span class="integer">5</span>) <span class="keyword">for</span> j <span class="keyword">in</span> <span class="predefined">range</span>(<span class="integer">5</span>)]
<span class="line-numbers"> 5</span>
<span class="line-numbers"> 6</span>    <span class="comment"># When</span>
<span class="line-numbers"> 7</span>    dispatcher.dispatch(issues)
<span class="line-numbers"> 8</span>
<span class="line-numbers"> 9</span>    <span class="comment"># Then</span>
<span class="line-numbers">10</span>    <span class="keyword">assert</span> ... <span class="comment"># some assertions</span></code></pre></div></div>
<div class="paragraph"><p>Avantages</p></div>
<div class="listingblock"><div class="content"><pre class="CodeRay highlight"><code data-lang="python"><span class="line-numbers">1</span><span class="keyword">class</span> <span class="class">GitlabIssueDispatcher</span>(IssueDispatcher): ...
<span class="line-numbers">2</span>
<span class="line-numbers">3</span><span class="keyword">class</span> <span class="class">GithubIssueDispatcher</span>(IssueDispatcher): ...
<span class="line-numbers">4</span>
<span class="line-numbers">5</span><span class="keyword">class</span> <span class="class">JiraIssueDispatcher</span>(IssueDispatcher): ...</code></pre></div></div></div></section></section>
<section id="_r√©sum√©_4"><h2>R√©sum√©</h2><div class="slide-content"><div class="imageblock center"><img src="../images/testability-hierarchy-slide-test_3.svg" alt="testability hierarchy slide test 3"></div>
<div class="imageblock center"><img src="../images/testability-hierarchy-slide-test_5.svg" alt="testability hierarchy slide test 5"></div></div></section>
<section><section id="_recherche_de_responsabilit√©_sur_legacy_temporaire"><h2>Recherche de responsabilit√© sur legacy (temporaire)</h2><div class="slide-content"><div class="ulist"><ul><li><p>Bad smells :</p><div class="ulist"><ul><li><p>Classe trop grosse ( <a href="https://refactoring.guru/fr/smells/large-class"><em>Large Class</em></a>)</p></li></ul></div></li></ul></div><aside class="notes"><div class="paragraph"><p>Nous avons vu que quand une classe semble lourde √† tester, qu&#8217;elle semble lourde √† tester, c&#8217;est souvent qu&#8217;elle porte trop de responsabilit√©s. Elle fait trop de choses.
Plusieurs experts se marchent dessus en permanence, il est temps de la d√©composer.
Ce genre de situation est une illustration de la dette technique: on a laiss√© la classe gonfler, en s&#8217;en servant comme pivot pour ajouter de nouvelles fonctionnalit√©s.
La th√©orie de la conception aurait voulu que son design soit m√ªrement r√©fl√©chi, et ses responsabilit√©s bien √©tablies √† l&#8217;avance. Mais ce n&#8217;est pas la r√©alit√© op√©rationnelle rencontr√©e.</p></div></aside></div></section><section id="_recherche_de_responsabilit√©_sur_legacy_temporaire_grouper_par_nom"><h2>Recherche de responsabilit√© sur legacy (temporaire) &gt; Grouper par nom</h2><div class="slide-content"><div class="ulist"><ul><li><p>Proximit√© s√©mantique</p><div class="ulist"><ul><li><p>Chercher les noms de variable, de fonction qui sont proches</p></li></ul></div></li></ul></div>
<div class="openblock"><div class="content"><div class="listingblock"><div class="content"><pre class="CodeRay highlight"><code data-lang="python"><span class="keyword">from</span> <span class="include">dataclasses</span> <span class="keyword">import</span> <span class="include">dataclass</span>

<span class="decorator">@dataclass</span>
<span class="keyword">class</span> <span class="class">People</span>:
    name: <span class="predefined">str</span>
    age: <span class="predefined">int</span>
    gender: <span class="predefined">str</span>
    address: <span class="predefined">str</span>
    phone_number: <span class="predefined">str</span>
    email: <span class="predefined">str</span>
    company_name: <span class="predefined">str</span>
    company_address: <span class="predefined">str</span>
    job_title: <span class="predefined">str</span>
    job_description: <span class="predefined">str</span></code></pre></div></div>
<div class="listingblock"><div class="content"><pre class="CodeRay highlight"><code data-lang="python">    <span class="keyword">def</span> <span class="function">send_email</span>(<span class="predefined-constant">self</span>, message: <span class="predefined">str</span>) -&gt; <span class="predefined-constant">None</span>: ...
    <span class="keyword">def</span> <span class="function">call_by_phone</span>(<span class="predefined-constant">self</span>) -&gt; <span class="predefined-constant">None</span>: ...
    <span class="keyword">def</span> <span class="function">change_job_title</span>(<span class="predefined-constant">self</span>, new_title: <span class="predefined">str</span>) -&gt; <span class="predefined-constant">None</span>: ...
    <span class="keyword">def</span> <span class="function">update_address</span>(<span class="predefined-constant">self</span>, new_address: <span class="predefined">str</span>) -&gt; <span class="predefined-constant">None</span>: ...
    <span class="keyword">def</span> <span class="function">get_personal_info</span>(<span class="predefined-constant">self</span>) -&gt; <span class="predefined">str</span>: ...
    <span class="keyword">def</span> <span class="function">get_company_info</span>(<span class="predefined-constant">self</span>) -&gt; <span class="predefined">str</span>: ...
    <span class="keyword">def</span> <span class="function">update_personal_info</span>(<span class="predefined-constant">self</span>, name: <span class="predefined">str</span>, age: <span class="predefined">int</span>, gender: <span class="predefined">str</span>, address: <span class="predefined">str</span>, phone_number: <span class="predefined">str</span>, email: <span class="predefined">str</span>) -&gt; <span class="predefined-constant">None</span>: ...
    <span class="keyword">def</span> <span class="function">update_company_info</span>(<span class="predefined-constant">self</span>, company_name: <span class="predefined">str</span>, company_address: <span class="predefined">str</span>, job_title: <span class="predefined">str</span>, job_description: <span class="predefined">str</span>) -&gt; <span class="predefined-constant">None</span>: ...
    <span class="keyword">def</span> <span class="function">calculate_salary</span>(<span class="predefined-constant">self</span>) -&gt; <span class="predefined">float</span>: ...
    <span class="keyword">def</span> <span class="function">hire_employee</span>(<span class="predefined-constant">self</span>, employee_info: <span class="predefined">dict</span>) -&gt; <span class="predefined-constant">None</span>: ...
    <span class="keyword">def</span> <span class="function">fire_employee</span>(<span class="predefined-constant">self</span>, employee_id: <span class="predefined">int</span>) -&gt; <span class="predefined-constant">None</span>: ...
    <span class="comment"># ... Other methods ...</span></code></pre></div></div></div></div></div></section><section id="_recherche_de_responsabilit√©_sur_legacy_temporaire_grouper_par_nom_2"><div class="slide-content"><div class="paragraph"><p>√âclatons les propri√©t√©s et les noms de m√©thodes</p></div>
<div class="imageblock center"><img src="../images/testability-srp_0.svg" alt="testability srp 0"></div></div></section><section id="_recherche_de_responsabilit√©_sur_legacy_temporaire_grouper_par_nom_3"><div class="slide-content"><div class="paragraph"><p>Identifions des groupes de propri√©t√©s et les noms de m√©thodes</p></div>
<div class="imageblock center"><img src="../images/testability-srp_1.svg" alt="testability srp 1"></div></div></section><section id="_recherche_de_responsabilit√©_sur_legacy_temporaire_grouper_par_nom_4"><div class="slide-content"><div class="paragraph"><p>Identifions des groupes de propri√©t√©s et de noms de m√©thodes</p></div>
<div class="imageblock center"><img src="../images/testability-srp_1.1.svg" alt="testability srp 1.1"></div></div></section><section id="_recherche_de_responsabilit√©_sur_legacy_temporaire_grouper_par_nom_5"><div class="slide-content"><div class="paragraph"><p>Relions des groupes de propri√©t√©s et de noms de m√©thodes</p></div>
<div class="imageblock center"><img src="../images/testability-srp_2.svg" alt="testability srp 2"></div></div></section><section id="_recherche_de_responsabilit√©_sur_legacy_temporaire_grouper_par_nom_6"><div class="slide-content"><div class="paragraph"><p>Identifions des responsabilit√©s</p></div>
<div class="imageblock center"><img src="../images/testability-srp_3.svg" alt="testability srp 3"></div></div></section><section id="_recherche_de_responsabilit√©_sur_legacy_temporaire_grouper_par_nom_7"><div class="slide-content"><div class="paragraph"><p>Reconsid√©rons la classe originelle</p></div>
<div class="imageblock center"><img src="../images/testability-srp_4.svg" alt="testability srp 4"></div></div></section><section id="_recherche_de_responsabilit√©_sur_legacy_temporaire_grouper_par_nom_8"><div class="slide-content"><div class="paragraph"><p>Nous avons d√©gag√© plusieurs responsabilit√©s diff√©rentes.</p></div>
<div class="paragraph"><p>La classe <code>People</code> devient une composition</p></div>
<div class="openblock left-column"><div class="content"><div class="listingblock"><div class="content"><pre class="CodeRay highlight"><code data-lang="python"><span class="keyword">from</span> <span class="include">dataclasses</span> <span class="keyword">import</span> <span class="include">dataclass</span>

<span class="decorator">@dataclass</span>
<span class="keyword">class</span> <span class="class">People</span>:
    person: Person
    address: Address
    phone_number: PhoneNumber
    email: Email
    company: Company
    job: Job</code></pre></div></div></div></div>
<div class="openblock right-column"><div class="content"><div class="imageblock right at-middle"><img src="../images/testability-srp_5.svg" alt="testability srp 5"></div></div></div>
<div class="paragraph reset-column"><p>Maintenant il est possible de tester chaque classe ind√©pendamment <em>chacune dans son  domaine d&#8217;expertise</em></p></div></div></section><section id="_recherche_de_responsabilit√©_sur_legacy_temporaire_grouper_par_nom_9"><h2>Recherche de responsabilit√© sur legacy (temporaire) &gt; Grouper par nom</h2><div class="slide-content"><div class="paragraph"><p>Et de se limiter aux rares m√©thodes qui implique plusieurs classes comme</p></div>
<div class="listingblock"><div class="content"><pre class="CodeRay highlight"><code data-lang="python"><span class="decorator">@dataclass</span>
<span class="keyword">class</span> <span class="class">People</span>:
    <span class="comment">#...</span>
    <span class="keyword">def</span> <span class="function">update_personal_info</span>(<span class="predefined-constant">self</span>, name: <span class="predefined">str</span>, age: <span class="predefined">int</span>, gender: <span class="predefined">str</span>, address: <span class="predefined">str</span>, phone_number: <span class="predefined">str</span>, email: <span class="predefined">str</span>) -&gt; <span class="predefined-constant">None</span>: ...
    <span class="keyword">def</span> <span class="function">update_company_info</span>(<span class="predefined-constant">self</span>, company_name: <span class="predefined">str</span>, company_address: <span class="predefined">str</span>, job_title: <span class="predefined">str</span>, job_description: <span class="predefined">str</span>) -&gt; <span class="predefined-constant">None</span>: ...
    <span class="keyword">def</span> <span class="function">calculate_salary</span>(<span class="predefined-constant">self</span>) -&gt; <span class="predefined">float</span>: ...
    <span class="keyword">def</span> <span class="function">hire_employee</span>(<span class="predefined-constant">self</span>, employee_info: <span class="predefined">dict</span>) -&gt; <span class="predefined-constant">None</span>: ...
    <span class="keyword">def</span> <span class="function">fire_employee</span>(<span class="predefined-constant">self</span>, employee_id: <span class="predefined">int</span>) -&gt; <span class="predefined-constant">None</span>: ...</code></pre></div></div></div></section><section id="_recherche_de_responsabilit√©_sur_legacy_temporaire_grouper_par_ce_qui_change"><h2>Recherche de responsabilit√© sur legacy (temporaire) &gt; Grouper par ce qui change</h2><div class="slide-content"><div class="ulist"><ul><li><p>Scratch refactoring</p><div class="ulist"><ul><li><p>&#8658; Modifier pour voir ce qui se passe</p></li><li><p>Ne pas chercher √† conserver</p></li><li><p>D√©couvrir les √©l√©ments qui "cassent" en m√™me temps</p></li></ul></div></li><li><p>Philosophie du scratch</p><div class="ulist"><ul><li><p><em>Ce qui change ensemble va ensemble</em></p></li><li><p><em>Ce qui ne casse pas ensemble ne va pas ensemble</em></p></li></ul></div></li><li><p>Attention de le faire dans une branche bidon.</p></li></ul></div>
<div class="imageblock at-middle-right"><img src="../images/scratch.png" alt="scratch"></div></div></section><section id="_recherche_de_responsabilit√©_sur_legacy_temporaire_grouper_par_relations"><h2>Recherche de responsabilit√© sur legacy (temporaire) &gt; Grouper par relations</h2><div class="slide-content"><div class="openblock left-column-2-3"><div class="content"><div class="ulist"><ul><li><p>Grouper par relations</p><div class="ulist"><ul><li><p>Si premi√®re approche s√©mantique KO</p><div class="ulist"><ul><li><p>&#8658; les noms sont mal form√©s (tiens, tiens&#8230;&#8203;) par exemple</p></li></ul></div></li><li><p>Etablir relations entre m√©thodes et propri√©t√©s <strong>dans le code</strong></p></li></ul></div></li><li><p>Faire un graphique</p><div class="ulist"><ul><li><p>cf <em>Working Effectively with Legacy Code. p 255</em></p></li></ul></div></li></ul></div></div></div>
<div class="openblock right-column-1-3"><div class="content"><div class="imageblock center"><img src="../images/capture_Working_graph.png" alt="capture Working graph" height="300"></div></div></div></div></section><section id="_recherche_de_responsabilit√©_sur_legacy_temporaire_grouper_par_relations_2"><div class="slide-content"><div class="imageblock center"><img src="../images/testability-srp_interne_0.svg" alt="testability srp interne 0"></div></div></section><section id="_recherche_de_responsabilit√©_sur_legacy_temporaire_grouper_par_relations_3"><div class="slide-content"><div class="imageblock center"><img src="../images/testability-srp_interne_1.svg" alt="testability srp interne 1"></div></div></section><section id="_recherche_de_responsabilit√©_sur_legacy_temporaire_grouper_par_relations_4"><div class="slide-content"><div class="imageblock center"><img src="../images/testability-srp_interne_2.svg" alt="testability srp interne 2"></div></div></section></section>
<section id="_m√©thode_mikado"><h2>M√©thode MIKADO</h2></section>
<section id="_am√©liorer_la_testabilit√©_2" class="end background center"><h2>Am√©liorer la testabilit√©</h2></section></div></div><script src="reveal.js/dist/reveal.js"></script><script>Array.prototype.slice.call(document.querySelectorAll('.slides section')).forEach(function(slide) {
  if (slide.getAttribute('data-background-color')) return;
  // user needs to explicitly say he wants CSS color to override otherwise we might break custom css or theme (#226)
  if (!(slide.classList.contains('canvas') || slide.classList.contains('background'))) return;
  var bgColor = getComputedStyle(slide).backgroundColor;
  if (bgColor !== 'rgba(0, 0, 0, 0)' && bgColor !== 'transparent') {
    slide.setAttribute('data-background-color', bgColor);
    slide.style.backgroundColor = 'transparent';
  }
});

// More info about config & dependencies:
// - https://github.com/hakimel/reveal.js#configuration
// - https://github.com/hakimel/reveal.js#dependencies
Reveal.initialize({
  // Display presentation control arrows
  controls: true,
  // Help the user learn the controls by providing hints, for example by
  // bouncing the down arrow when they first encounter a vertical slide
  controlsTutorial: true,
  // Determines where controls appear, "edges" or "bottom-right"
  controlsLayout: 'bottom-right',
  // Visibility rule for backwards navigation arrows; "faded", "hidden"
  // or "visible"
  controlsBackArrows: 'faded',
  // Display a presentation progress bar
  progress: true,
  // Display the page number of the current slide
  slideNumber: 'true',
  // Control which views the slide number displays on
  showSlideNumber: 'all',
  // Add the current slide number to the URL hash so that reloading the
  // page/copying the URL will return you to the same slide
  hash: false,
  // Push each slide change to the browser history. Implies `hash: true`
  history: true,
  // Enable keyboard shortcuts for navigation
  keyboard: true,
  // Enable the slide overview mode
  overview: true,
  // Disables the default reveal.js slide layout so that you can use custom CSS layout
  disableLayout: false,
  // Vertical centering of slides
  center: false,
  // Enables touch navigation on devices with touch input
  touch: true,
  // Loop the presentation
  loop: false,
  // Change the presentation direction to be RTL
  rtl: false,
  // See https://github.com/hakimel/reveal.js/#navigation-mode
  navigationMode: 'default',
  // Randomizes the order of slides each time the presentation loads
  shuffle: false,
  // Turns fragments on and off globally
  fragments: true,
  // Flags whether to include the current fragment in the URL,
  // so that reloading brings you to the same fragment position
  fragmentInURL: false,
  // Flags if the presentation is running in an embedded mode,
  // i.e. contained within a limited portion of the screen
  embedded: false,
  // Flags if we should show a help overlay when the questionmark
  // key is pressed
  help: true,
  // Flags if speaker notes should be visible to all viewers
  showNotes: false,
  // Global override for autolaying embedded media (video/audio/iframe)
  // - null: Media will only autoplay if data-autoplay is present
  // - true: All media will autoplay, regardless of individual setting
  // - false: No media will autoplay, regardless of individual setting
  autoPlayMedia: null,
  // Global override for preloading lazy-loaded iframes
  // - null: Iframes with data-src AND data-preload will be loaded when within
  //   the viewDistance, iframes with only data-src will be loaded when visible
  // - true: All iframes with data-src will be loaded when within the viewDistance
  // - false: All iframes with data-src will be loaded only when visible
  preloadIframes: null,
  // Number of milliseconds between automatically proceeding to the
  // next slide, disabled when set to 0, this value can be overwritten
  // by using a data-autoslide attribute on your slides
  autoSlide: 0,
  // Stop auto-sliding after user input
  autoSlideStoppable: true,
  // Use this method for navigation when auto-sliding
  autoSlideMethod: Reveal.navigateNext,
  // Specify the average time in seconds that you think you will spend
  // presenting each slide. This is used to show a pacing timer in the
  // speaker view
  defaultTiming: 120,
  // Specify the total time in seconds that is available to
  // present.  If this is set to a nonzero value, the pacing
  // timer will work out the time available for each slide,
  // instead of using the defaultTiming value
  totalTime: 0,
  // Specify the minimum amount of time you want to allot to
  // each slide, if using the totalTime calculation method.  If
  // the automated time allocation causes slide pacing to fall
  // below this threshold, then you will see an alert in the
  // speaker notes window
  minimumTimePerSlide: 0,
  // Enable slide navigation via mouse wheel
  mouseWheel: true,
  // Hide cursor if inactive
  hideInactiveCursor: true,
  // Time before the cursor is hidden (in ms)
  hideCursorTime: 5000,
  // Hides the address bar on mobile devices
  hideAddressBar: true,
  // Opens links in an iframe preview overlay
  // Add `data-preview-link` and `data-preview-link="false"` to customise each link
  // individually
  previewLinks: false,
  // Transition style (e.g., none, fade, slide, convex, concave, zoom)
  transition: 'fast',
  // Transition speed (e.g., default, fast, slow)
  transitionSpeed: 'default',
  // Transition style for full page slide backgrounds (e.g., none, fade, slide, convex, concave, zoom)
  backgroundTransition: 'default',
  // Number of slides away from the current that are visible
  viewDistance: 3,
  // Number of slides away from the current that are visible on mobile
  // devices. It is advisable to set this to a lower number than
  // viewDistance in order to save resources.
  mobileViewDistance: 3,
  // Parallax background image (e.g., "'https://s3.amazonaws.com/hakim-static/reveal-js/reveal-parallax-1.jpg'")
  parallaxBackgroundImage: '',
  // Parallax background size in CSS syntax (e.g., "2100px 900px")
  parallaxBackgroundSize: '',
  // Number of pixels to move the parallax background per slide
  // - Calculated automatically unless specified
  // - Set to 0 to disable movement along an axis
  parallaxBackgroundHorizontal: null,
  parallaxBackgroundVertical: null,
  // The display mode that will be used to show slides
  display: 'block',

  // The "normal" size of the presentation, aspect ratio will be preserved
  // when the presentation is scaled to fit different resolutions. Can be
  // specified using percentage units.
  width: 1280,
  height: 800,

  // Factor of the display size that should remain empty around the content
  margin: 0.02,

  // Bounds for smallest/largest possible scale to apply to content
  minScale: 0.2,
  maxScale: 1.5,

  // PDF Export Options
  // Put each fragment on a separate page
  pdfSeparateFragments: true,
  // For slides that do not fit on a page, max number of pages
  pdfMaxPagesPerSlide: 1,

  // Optional libraries used to extend on reveal.js
  dependencies: [
      { src: 'reveal.js/plugin/zoom/zoom.js', async: true, callback: function () { Reveal.registerPlugin(RevealZoom) } },
      { src: 'reveal.js/plugin/notes/notes.js', async: true, callback: function () { Reveal.registerPlugin(RevealNotes) } }
  ],
});</script><script>var dom = {};
dom.slides = document.querySelector('.reveal .slides');

function getRemainingHeight(element, slideElement, height) {
  height = height || 0;
  if (element) {
    var newHeight, oldHeight = element.style.height;
    // Change the .stretch element height to 0 in order find the height of all
    // the other elements
    element.style.height = '0px';
    // In Overview mode, the parent (.slide) height is set of 700px.
    // Restore it temporarily to its natural height.
    slideElement.style.height = 'auto';
    newHeight = height - slideElement.offsetHeight;
    // Restore the old height, just in case
    element.style.height = oldHeight + 'px';
    // Clear the parent (.slide) height. .removeProperty works in IE9+
    slideElement.style.removeProperty('height');
    return newHeight;
  }
  return height;
}

function layoutSlideContents(width, height) {
  // Handle sizing of elements with the 'stretch' class
  toArray(dom.slides.querySelectorAll('section .stretch')).forEach(function (element) {
    // Determine how much vertical space we can use
    var limit = 5; // hard limit
    var parent = element.parentNode;
    while (parent.nodeName !== 'SECTION' && limit > 0) {
      parent = parent.parentNode;
      limit--;
    }
    if (limit === 0) {
      // unable to find parent, aborting!
      return;
    }
    var remainingHeight = getRemainingHeight(element, parent, height);
    // Consider the aspect ratio of media elements
    if (/(img|video)/gi.test(element.nodeName)) {
      var nw = element.naturalWidth || element.videoWidth, nh = element.naturalHeight || element.videoHeight;
      var es = Math.min(width / nw, remainingHeight / nh);
      element.style.width = (nw * es) + 'px';
      element.style.height = (nh * es) + 'px';
    } else {
      element.style.width = width + 'px';
      element.style.height = remainingHeight + 'px';
    }
  });
}

function toArray(o) {
  return Array.prototype.slice.call(o);
}

Reveal.addEventListener('slidechanged', function () {
  layoutSlideContents(1280, 800)
});
Reveal.addEventListener('ready', function () {
  layoutSlideContents(1280, 800)
});
Reveal.addEventListener('resize', function () {
  layoutSlideContents(1280, 800)
});</script></body></html>